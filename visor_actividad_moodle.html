<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Visor de Actividad Moodle</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-T3c6CoIi6uLrA9TneNEoa7RxnatzjcDSCmG1MXxSR1GAsXEV/Dwwykc2MPK8M2HN" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.7.0/dist/chart.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns@2.0.0/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/date-fns@2.23.0/esm/index.js" type="module"></script> 

    <style>
        body {
            padding-top: 56px; 
            background-color: #f8f9fa;
        }
        .chart-container-modal { 
            position: relative;
            margin: auto;
            height: 85vh; 
            width: 100%;
        }
        .chart-card .card-body canvas {
            min-height: 220px; 
            max-height: 250px;
            width: 100%;
        }
        .chart-card {
            cursor: pointer; 
        }
        .chart-card:hover {
            border-color: #0d6efd; 
            box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
        }
        #resultsSection.hidden,
        #loadingIndicator.hidden {
            display: none;
        }
        .sticky-controls {
            position: sticky;
            top: 56px; 
            background-color: #ffffff; 
            z-index: 999; 
        }
        .sticky-controls .card { 
             border-bottom: 1px solid #dee2e6;
             box-shadow: 0 2px 4px rgba(0,0,0,.1);
             margin-bottom: 1.5rem; 
        }

        .filters-scroll-area {
            max-height: 30vh;
            overflow-y: auto; 
            padding-right: 5px; 
            margin-top: 0.5rem; 
        }
        .filter-group {
            border-left: 3px solid #0d6efd;
            padding-left: 0.75rem;
        }
        .table-responsive {
            max-height: 500px; 
        }
        .spinner-border {
            width: 3rem;
            height: 3rem;
        }
        .card-header { /* Modificado para flex */
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .card-header h2, .card-header h3 { 
            font-size: 0.90rem;
            font-weight: 600;
            margin-bottom: 0; /* Asegurar que no haya margen extra */
        }
        .navbar {
            z-index: 1050; 
        }
        .navbar-nav .nav-link {
            padding-right: .5rem;
            padding-left: .5rem;
        }
        .modal-fullscreen .modal-body {
            overflow-y: auto;
        }
        #dashboardGeneralStats p {
            font-size: 0.8rem; 
            margin-bottom: 0.3rem !important;
        }
        #dashboardGeneralStats .badge {
            font-size: 0.75rem;
        }
        .stat-label {
            color: #6c757d; 
        }
        .accordion-button:not(.collapsed) {
            color: #0c63e4; 
            background-color: #e7f1ff; 
        }
        .accordion-button:focus {
            box-shadow: 0 0 0 0.25rem rgba(13, 110, 253, .25); 
        }
        #ipFilter[multiple] {
            min-height: 70px; 
        }
        .help-button { /* Estilo para el botón de ayuda */
            padding: 0.25rem 0.5rem;
            line-height: 1;
        }
        /* Ajuste para etiquetas de filtro en móviles */
        @media (max-width: 767.98px) {
            .filters-scroll-area .form-label {
                font-size: 0.85rem;
            }
            .form-check-label {
                font-size: 0.85rem;
            }
            .card-header h3 {
                font-size: 0.8rem; /* Ajustar tamaño título en móviles si es necesario */
            }
        }
    </style>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark fixed-top">
        <div class="container-fluid">
            <a class="navbar-brand" href="#">Visor Moodle</a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ms-auto">
                     <li class="nav-item">
                        <a class="nav-link" href="#" data-bs-toggle="modal" data-bs-target="#settingsModal" title="Configuración">
                            <i class="bi bi-gear-fill"></i>
                        </a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <div class="container-fluid px-md-4 pt-4">
        <header class="text-center mb-4">
            <h3 class="fw-light">Visor de Actividad Moodle</h3>
        </header>

        <div class="sticky-controls">
            <div class="card">
                <div class="accordion" id="analysisControlsAccordion">
                    <div class="accordion-item">
                        <h2 class="accordion-header" id="controlsAccordionHeader">
                            <button class="accordion-button" type="button" data-bs-toggle="collapse" data-bs-target="#collapseControls" aria-expanded="true" aria-controls="collapseControls">
                                Configuración de Análisis y Filtros
                            </button>
                        </h2>
                        <div id="collapseControls" class="accordion-collapse collapse show" aria-labelledby="controlsAccordionHeader" data-bs-parent="#analysisControlsAccordion">
                            <div class="accordion-body">
                                <div class="row g-3 align-items-end">
                                    <div class="col-md-12 mb-3">
                                        <label for="csvFile" class="form-label fw-bold">1. Selecciona el archivo CSV:</label>
                                        <input class="form-control" type="file" id="csvFile" accept=".csv">
                                    </div>
                                    
                                    <div class="col-md-12 filter-group mb-3">
                                        <p class="form-label fw-bold mb-1">2. Filtros de Análisis:</p>
                                        <div class="form-check form-switch mb-2">
                                            <input class="form-check-input" type="checkbox" role="switch" id="includeZeroActivitySwitch">
                                            <label class="form-check-label" for="includeZeroActivitySwitch">Incluir ítems con 0 actividad en rankings</label>
                                        </div>
                                        <div class="filters-scroll-area">
                                            <div class="row g-2">
                                                <div class="col-md-4 col-lg-2">
                                                    <label for="startDate" class="form-label">Fecha Inicio:</label>
                                                    <input type="date" class="form-control form-control-sm" id="startDate">
                                                </div>
                                                <div class="col-md-4 col-lg-2">
                                                    <label for="endDate" class="form-label">Fecha Fin:</label>
                                                    <input type="date" class="form-control form-control-sm" id="endDate">
                                                </div>
                                                <div class="col-md-4 col-lg-2">
                                                    <label for="startTimeFilter" class="form-label">Hora Inicio:</label>
                                                    <input type="time" class="form-control form-control-sm" id="startTimeFilter" value="00:00">
                                                </div>
                                                <div class="col-md-4 col-lg-2">
                                                    <label for="endTimeFilter" class="form-label">Hora Fin:</label>
                                                    <input type="time" class="form-control form-control-sm" id="endTimeFilter" value="23:59">
                                                </div>
                                                <div class="col-md-4 col-lg-2">
                                                    <label for="userFilter" class="form-label">Alumno:</label>
                                                    <select id="userFilter" class="form-select form-select-sm">
                                                        <option value="ALL_USERS">Todos los Alumnos</option>
                                                    </select>
                                                </div>
                                                <div class="col-md-4 col-lg-2">
                                                    <label for="eventFilter" class="form-label">Nombre Evento:</label>
                                                    <select id="eventFilter" class="form-select form-select-sm">
                                                        <option value="ALL_EVENTS">Todos los Eventos</option>
                                                    </select>
                                                </div>
                                            </div>
                                            <div class="row g-2 mt-2">
                                                <div class="col-md-4">
                                                    <label for="componentFilter" class="form-label">Componente:</label>
                                                    <select id="componentFilter" class="form-select form-select-sm">
                                                        <option value="ALL_COMPONENTS">Todos los Componentes</option>
                                                    </select>
                                                </div>
                                                <div class="col-md-4">
                                                    <label for="contextFilter" class="form-label">Contexto Evento:</label>
                                                    <select id="contextFilter" class="form-select form-select-sm">
                                                        <option value="ALL_CONTEXTS">Todos los Contextos</option>
                                                    </select>
                                                </div>
                                                 <div class="col-md-4">
                                                    <label for="ipFilter" class="form-label">Dirección IP:</label>
                                                    <select id="ipFilter" class="form-select form-select-sm" multiple size="3">
                                                    </select>
                                                    <div class="form-text" id="ipFilterHelp">Seleccione una o más IPs. Ninguna selección implica todas.</div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    <div class="col-md-12 d-grid">
                                        <button id="analyzeButton" class="btn btn-primary btn-lg">Analizar Logs</button>
                                    </div>
                                </div>
                                <div id="statusMessage" class="mt-3 pt-2 border-top"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div id="loadingIndicator" class="text-center my-5 hidden">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Cargando...</span>
            </div>
            <p class="mt-2">Procesando datos...</p>
        </div>
        
        <main id="resultsSection" class="hidden">
            <div class="container-fluid px-0"> 
                <div class="row mb-3 g-3">
                    <div class="col-xl-3 col-md-6">
                        <div class="card h-100">
                            <div class="card-header">
                                <h3 class="h6 mb-0">Estadísticas Generales</h3>
                                <button type="button" class="btn btn-outline-secondary btn-sm rounded-circle help-button" data-bs-toggle="modal" data-bs-target="#helpModal" data-chart-help-type="generalStats" title="Ayuda sobre Estadísticas Generales">
                                    <i class="bi bi-question-lg"></i>
                                </button>
                            </div>
                            <div class="card-body" id="dashboardGeneralStats">
                                <p><span class="stat-label">Rango Fechas:</span> <span id="dashDateRange" class="fw-bold">N/A</span></p>
                                <p><span class="stat-label">Total Eventos:</span> <span id="dashTotalEvents" class="badge bg-primary">N/A</span></p>
                                <p><span class="stat-label">Usuarios Únicos:</span> <span id="dashUniqueUsers" class="badge bg-info">N/A</span></p>
                                <p><span class="stat-label">Días con Actividad:</span> <span id="dashActiveDays" class="badge bg-success">N/A</span></p>
                                <p><span class="stat-label">Promedio Eventos/Día:</span> <span id="dashAvgEventsPerDay" class="badge bg-warning text-dark">N/A</span></p>
                                <p><span class="stat-label">Evento Más Frecuente:</span> <span id="dashMostFrequentEventName" class="badge bg-secondary text-truncate d-block" style="max-width: 100%;">N/A</span></p>
                                <p><span class="stat-label">Componente Más Accedido:</span> <span id="dashMostFrequentComponent" class="badge bg-secondary text-truncate d-block" style="max-width: 100%;">N/A</span></p>
                                <p class="mb-0"><span class="stat-label">Usuario Más Activo:</span> <span id="dashMostActiveUser" class="badge bg-dark text-truncate d-block" style="max-width: 100%;">N/A</span></p>
                            </div>
                        </div>
                    </div>
                    <div class="col-xl-3 col-md-6">
                        <div class="card h-100 chart-card" data-modal-target="#userActivityModal" data-chart-type="userActivity">
                             <div class="card-header">
                                <h3 class="h6 mb-0">Actividad por Alumno (Top 15)</h3>
                                <button type="button" class="btn btn-outline-secondary btn-sm rounded-circle help-button" data-bs-toggle="modal" data-bs-target="#helpModal" data-chart-help-type="userActivity" title="Ayuda sobre este gráfico">
                                    <i class="bi bi-question-lg"></i>
                                </button>
                            </div>
                            <div class="card-body">
                                <canvas id="dashUserActivityChart"></canvas>
                            </div>
                        </div>
                    </div>
                    <div class="col-xl-3 col-md-6">
                        <div class="card h-100 chart-card" data-modal-target="#eventsOverTimeModal" data-chart-type="eventsOverTime">
                            <div class="card-header">
                                <h3 class="h6 mb-0">Eventos por Día</h3>
                                <button type="button" class="btn btn-outline-secondary btn-sm rounded-circle help-button" data-bs-toggle="modal" data-bs-target="#helpModal" data-chart-help-type="eventsOverTime" title="Ayuda sobre este gráfico">
                                    <i class="bi bi-question-lg"></i>
                                </button>
                            </div>
                            <div class="card-body">
                                <canvas id="dashEventsOverTimeChart"></canvas>
                            </div>
                        </div>
                    </div>
                    <div class="col-xl-3 col-md-6">
                        <div class="card h-100 chart-card" data-modal-target="#componentActivityModal" data-chart-type="componentActivity">
                            <div class="card-header">
                                <h3 class="h6 mb-0">Actividad por Componente (Top 10)</h3>
                                <button type="button" class="btn btn-outline-secondary btn-sm rounded-circle help-button" data-bs-toggle="modal" data-bs-target="#helpModal" data-chart-help-type="componentActivity" title="Ayuda sobre este gráfico">
                                    <i class="bi bi-question-lg"></i>
                                </button>
                            </div>
                            <div class="card-body">
                                <canvas id="dashComponentActivityChart"></canvas>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="row mb-3 g-3">
                    <div class="col-xl-3 col-md-6">
                        <div class="card h-100 chart-card" data-modal-target="#activityByHourModal" data-chart-type="activityByHour">
                            <div class="card-header">
                                <h3 class="h6 mb-0">Eventos por Hora del Día</h3>
                                <button type="button" class="btn btn-outline-secondary btn-sm rounded-circle help-button" data-bs-toggle="modal" data-bs-target="#helpModal" data-chart-help-type="activityByHour" title="Ayuda sobre este gráfico">
                                    <i class="bi bi-question-lg"></i>
                                </button>
                            </div>
                            <div class="card-body">
                                <canvas id="dashActivityByHourChart"></canvas>
                            </div>
                        </div>
                    </div>
                    <div class="col-xl-3 col-md-6">
                        <div class="card h-100 chart-card" data-modal-target="#activityByDayOfWeekModal" data-chart-type="activityByDayOfWeek">
                            <div class="card-header">
                                <h3 class="h6 mb-0">Eventos por Día de Semana</h3>
                                <button type="button" class="btn btn-outline-secondary btn-sm rounded-circle help-button" data-bs-toggle="modal" data-bs-target="#helpModal" data-chart-help-type="activityByDayOfWeek" title="Ayuda sobre este gráfico">
                                    <i class="bi bi-question-lg"></i>
                                </button>
                            </div>
                            <div class="card-body">
                                <canvas id="dashActivityByDayOfWeekChart"></canvas>
                            </div>
                        </div>
                    </div>
                    <div class="col-xl-3 col-md-6">
                        <div class="card h-100 chart-card" data-modal-target="#componentBreakdownModal" data-chart-type="componentBreakdown">
                            <div class="card-header">
                                <h3 class="h6 mb-0">Desglose Eventos en Componentes</h3>
                                <button type="button" class="btn btn-outline-secondary btn-sm rounded-circle help-button" data-bs-toggle="modal" data-bs-target="#helpModal" data-chart-help-type="componentBreakdown" title="Ayuda sobre este gráfico">
                                    <i class="bi bi-question-lg"></i>
                                </button>
                            </div>
                            <div class="card-body">
                                <canvas id="dashComponentBreakdownChart"></canvas>
                            </div>
                        </div>
                    </div>
                     <div class="col-xl-3 col-md-6">
                        <div class="card h-100 chart-card" data-modal-target="#activityByContextModal" data-chart-type="activityByContext">
                            <div class="card-header">
                                <h3 class="h6 mb-0">Actividad por Contexto (Top 10)</h3>
                                <button type="button" class="btn btn-outline-secondary btn-sm rounded-circle help-button" data-bs-toggle="modal" data-bs-target="#helpModal" data-chart-help-type="activityByContext" title="Ayuda sobre este gráfico">
                                    <i class="bi bi-question-lg"></i>
                                </button>
                            </div>
                            <div class="card-body">
                                <canvas id="dashActivityByContextChart"></canvas>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="row mb-3 g-3">
                    <div class="col-xl-4 col-md-6">
                        <div class="card h-100 chart-card" data-modal-target="#scatterUsersEventsDayModal" data-chart-type="scatterUsersEventsDay">
                            <div class="card-header">
                                <h3 class="h6 mb-0">Usuarios Únicos vs Eventos (por Día)</h3>
                                 <button type="button" class="btn btn-outline-secondary btn-sm rounded-circle help-button" data-bs-toggle="modal" data-bs-target="#helpModal" data-chart-help-type="scatterUsersEventsDay" title="Ayuda sobre este gráfico">
                                    <i class="bi bi-question-lg"></i>
                                </button>
                            </div>
                            <div class="card-body">
                                <canvas id="dashScatterUsersEventsDayChart"></canvas>
                            </div>
                        </div>
                    </div>
                    <div class="col-xl-4 col-md-6">
                        <div class="card h-100 chart-card" data-modal-target="#scatterComponentsEventsUserModal" data-chart-type="scatterComponentsEventsUser">
                           <div class="card-header">
                                <h3 class="h6 mb-0">Componentes Únicos vs Eventos (por Alumno)</h3>
                                 <button type="button" class="btn btn-outline-secondary btn-sm rounded-circle help-button" data-bs-toggle="modal" data-bs-target="#helpModal" data-chart-help-type="scatterComponentsEventsUser" title="Ayuda sobre este gráfico">
                                    <i class="bi bi-question-lg"></i>
                                </button>
                            </div>
                            <div class="card-body">
                                <canvas id="dashScatterComponentsEventsUserChart"></canvas>
                            </div>
                        </div>
                    </div>
                    <div class="col-xl-4 col-md-6">
                        <div class="card h-100 chart-card" data-modal-target="#scatterContentViewParticipationModal" data-chart-type="scatterContentViewParticipation">
                            <div class="card-header">
                                <h3 class="h6 mb-0">Visualización vs Participación (por Alumno)</h3>
                                <button type="button" class="btn btn-outline-secondary btn-sm rounded-circle help-button" data-bs-toggle="modal" data-bs-target="#helpModal" data-chart-help-type="scatterContentViewParticipation" title="Ayuda sobre este gráfico">
                                    <i class="bi bi-question-lg"></i>
                                </button>
                            </div>
                            <div class="card-body">
                                <canvas id="dashScatterContentViewParticipationChart"></canvas>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="row mb-3 g-3">
                    <div class="col-xl-4 col-md-6">
                        <div class="card h-100 chart-card" data-modal-target="#bubbleStudentAnalysisModal" data-chart-type="bubbleStudentAnalysis">
                            <div class="card-header">
                                <h3 class="h6 mb-0">Análisis Alumnos (Días Act./ØEvtDia/TotalEvt)</h3>
                                <button type="button" class="btn btn-outline-secondary btn-sm rounded-circle help-button" data-bs-toggle="modal" data-bs-target="#helpModal" data-chart-help-type="bubbleStudentAnalysis" title="Ayuda sobre este gráfico">
                                    <i class="bi bi-question-lg"></i>
                                </button>
                            </div>
                            <div class="card-body">
                                <canvas id="dashBubbleStudentAnalysisChart"></canvas>
                            </div>
                        </div>
                    </div>
                    <div class="col-xl-4 col-md-6">
                        <div class="card h-100 chart-card" data-modal-target="#bubbleComponentAnalysisModal" data-chart-type="bubbleComponentAnalysis">
                            <div class="card-header">
                                <h3 class="h6 mb-0">Análisis Componentes (UsrUnicos/TotalEvt/ØEvtUsr)</h3>
                                <button type="button" class="btn btn-outline-secondary btn-sm rounded-circle help-button" data-bs-toggle="modal" data-bs-target="#helpModal" data-chart-help-type="bubbleComponentAnalysis" title="Ayuda sobre este gráfico">
                                    <i class="bi bi-question-lg"></i>
                                </button>
                            </div>
                            <div class="card-body">
                                <canvas id="dashBubbleComponentAnalysisChart"></canvas>
                            </div>
                        </div>
                    </div>
                    <div class="col-xl-4 col-md-6">
                        <div class="card h-100 chart-card" data-modal-target="#bubbleContextAnalysisModal" data-chart-type="bubbleContextAnalysis">
                            <div class="card-header">
                                <h3 class="h6 mb-0">Análisis Contextos (AluAct/ØEvtAlu/TotalEvt)</h3>
                                <button type="button" class="btn btn-outline-secondary btn-sm rounded-circle help-button" data-bs-toggle="modal" data-bs-target="#helpModal" data-chart-help-type="bubbleContextAnalysis" title="Ayuda sobre este gráfico">
                                    <i class="bi bi-question-lg"></i>
                                </button>
                            </div>
                            <div class="card-body">
                                <canvas id="dashBubbleContextAnalysisChart"></canvas>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="row mb-3 g-3">
                    <div class="col-xl-4 col-md-6">
                        <div class="card h-100 chart-card" data-modal-target="#topIPsByEventsModal" data-chart-type="topIPsByEvents">
                            <div class="card-header">
                                <h3 class="h6 mb-0">Top IPs por N° Eventos (Top 10)</h3>
                                <button type="button" class="btn btn-outline-secondary btn-sm rounded-circle help-button" data-bs-toggle="modal" data-bs-target="#helpModal" data-chart-help-type="topIPsByEvents" title="Ayuda sobre este gráfico">
                                    <i class="bi bi-question-lg"></i>
                                </button>
                            </div>
                            <div class="card-body">
                                <canvas id="dashTopIPsByEventsChart"></canvas>
                            </div>
                        </div>
                    </div>
                    <div class="col-xl-4 col-md-6">
                        <div class="card h-100 chart-card" data-modal-target="#usersPerIPModal" data-chart-type="usersPerIP">
                            <div class="card-header">
                                <h3 class="h6 mb-0">Top IPs por N° Alumnos (Top 10)</h3>
                                <button type="button" class="btn btn-outline-secondary btn-sm rounded-circle help-button" data-bs-toggle="modal" data-bs-target="#helpModal" data-chart-help-type="usersPerIP" title="Ayuda sobre este gráfico">
                                    <i class="bi bi-question-lg"></i>
                                </button>
                            </div>
                            <div class="card-body">
                                <canvas id="dashUsersPerIPChart"></canvas>
                            </div>
                        </div>
                    </div>
                    <div class="col-xl-4 col-md-6">
                        <div class="card h-100 chart-card" data-modal-target="#ipsPerUserModal" data-chart-type="ipsPerUser">
                           <div class="card-header">
                                <h3 class="h6 mb-0">Top Alumnos por N° IPs (Top 10)</h3>
                                <button type="button" class="btn btn-outline-secondary btn-sm rounded-circle help-button" data-bs-toggle="modal" data-bs-target="#helpModal" data-chart-help-type="ipsPerUser" title="Ayuda sobre este gráfico">
                                    <i class="bi bi-question-lg"></i>
                                </button>
                            </div>
                            <div class="card-body">
                                <canvas id="dashIPsPerUserChart"></canvas>
                            </div>
                        </div>
                    </div>
                </div>

            </div>

            <section id="logTableSection" class="mt-4 card shadow-sm">
                <div class="card-header d-flex justify-content-between align-items-center">
                     <h2 class="h5 mb-0">Detalle de Logs Filtrados</h2>
                     <button id="downloadLogsCsvButton" class="btn btn-sm btn-outline-primary" title="Descargar Logs Filtrados (CSV)">
                         <i class="bi bi-download"></i> Descargar CSV
                     </button>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-striped table-hover table-sm">
                            <thead>
                                <tr>
                                    <th>Hora</th>
                                    <th>Nombre completo del usuario</th>
                                    <th>Contexto del evento</th>
                                    <th>Componente</th>
                                    <th>Nombre evento</th>
                                    <th>Descripción</th>
                                </tr>
                            </thead>
                            <tbody id="logTableBody">
                            </tbody>
                        </table>
                    </div>
                     <p id="tableRowCount" class="mt-2 text-muted small"></p>
                </div>
            </section>
        </main>

        <footer class="text-center mt-5 text-muted">
            <p>&copy; <span id="currentYear"></span> Visor de Actividad Moodle.</p>
        </footer>
    </div>

    <!-- Modal de Configuración (Existente) -->
    <div class="modal fade" id="settingsModal" tabindex="-1" aria-labelledby="settingsModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="settingsModalLabel">Configuración de Exclusiones y Patrones</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <h6>Exclusiones Globales</h6>
                    <p class="form-text">Los elementos que contengan cualquiera de estas subcadenas (separadas por coma, insensible a mayúsculas/minúsculas) serán excluidos de todos los análisis, gráficos y listados.</p>
                    <div class="mb-3">
                        <label for="excludedUsernamesTextarea" class="form-label">Excluir Alumnos por nombre:</label>
                        <textarea class="form-control" id="excludedUsernamesTextarea" rows="2" placeholder="Ej: Fernández, Jose, Admin User"></textarea>
                    </div>
                     <div class="mb-3">
                        <label for="excludedComponentsTextarea" class="form-label">Excluir Componentes por nombre:</label>
                        <textarea class="form-control" id="excludedComponentsTextarea" rows="2" placeholder="Ej: Sistema, Foro, Tarea"></textarea>
                    </div>
                     <div class="mb-3">
                        <label for="excludedEventNamesTextarea" class="form-label">Excluir Nombres de Evento:</label>
                        <textarea class="form-control" id="excludedEventNamesTextarea" rows="2" placeholder="Ej: course viewed, user loggedin, some_internal_event"></textarea>
                    </div>
                     <div class="mb-3">
                        <label for="excludedContextsTextarea" class="form-label">Excluir Contextos de Evento:</label>
                        <textarea class="form-control" id="excludedContextsTextarea" rows="2" placeholder="Ej: Curso Principal, Categoría X, Actividad Y"></textarea>
                    </div>
                    
                    <hr class="my-4">
                    <h6>Patrones para Gráfico 'Visualización vs Participación'</h6>
                     <div class="mb-3">
                        <label for="viewEventPatternsTextarea" class="form-label">Patrones Eventos de Visualización (subcadenas, separadas por coma):</label>
                        <textarea class="form-control" id="viewEventPatternsTextarea" rows="2" placeholder="Ej: viewed, consultado, vista"></textarea>
                        <div class="form-text">Usado para el gráfico 'Visualización vs Participación'. Sensible a mayúsculas/minúsculas si no se pre-procesa globalmente.</div>
                    </div>
                    <div class="mb-3">
                        <label for="participationEventPatternsTextarea" class="form-label">Patrones Eventos de Participación (subcadenas, separadas por coma):</label>
                        <textarea class="form-control" id="participationEventPatternsTextarea" rows="2" placeholder="Ej: submitted, posted, answered, participado"></textarea>
                        <div class="form-text">Usado para el gráfico 'Visualización vs Participación'. Un evento se cuenta como participación si coincide aquí Y NO en visualización.</div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
                    <button type="button" class="btn btn-primary" id="saveSettingsButton">Guardar Cambios y Reanalizar</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Modal de Ayuda Genérico -->
    <div class="modal fade" id="helpModal" tabindex="-1" aria-labelledby="helpModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg modal-dialog-scrollable">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="helpModalTitle">Ayuda del Elemento</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body" id="helpModalBody">
                    <p>Cargando ayuda...</p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modales de Gráficos Detallados (Existentes) -->
    <div class="modal fade" id="userActivityModal" tabindex="-1" aria-labelledby="userActivityModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-fullscreen">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="userActivityModalLabel">Actividad por Alumno (Detallado)</h5>
                    <div>
                        <button class="btn btn-sm btn-outline-secondary me-2 download-chart-csv-button" data-chart-type="userActivity" title="Descargar datos del gráfico (CSV)">
                            <i class="bi bi-download"></i> CSV
                        </button>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                </div>
                <div class="modal-body">
                    <div class="chart-container-modal">
                        <canvas id="activityByUserChart"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="componentActivityModal" tabindex="-1" aria-labelledby="componentActivityModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-fullscreen">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="componentActivityModalLabel">Actividad por Componente (Detallado)</h5>
                    <div>
                        <button class="btn btn-sm btn-outline-secondary me-2 download-chart-csv-button" data-chart-type="componentActivity" title="Descargar datos del gráfico (CSV)">
                            <i class="bi bi-download"></i> CSV
                        </button>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                </div>
                <div class="modal-body">
                    <div class="chart-container-modal">
                        <canvas id="activityByComponentChart"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="eventsOverTimeModal" tabindex="-1" aria-labelledby="eventsOverTimeModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-fullscreen">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="eventsOverTimeModalLabel">Eventos por Día (Detallado)</h5>
                    <div>
                        <button class="btn btn-sm btn-outline-secondary me-2 download-chart-csv-button" data-chart-type="eventsOverTime" title="Descargar datos del gráfico (CSV)">
                            <i class="bi bi-download"></i> CSV
                        </button>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                </div>
                <div class="modal-body">
                    <div class="chart-container-modal">
                        <canvas id="eventsOverTimeChart"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="activityByHourModal" tabindex="-1" aria-labelledby="activityByHourModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-fullscreen">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="activityByHourModalLabel">Eventos por Hora del Día (Detallado)</h5>
                    <div>
                        <button class="btn btn-sm btn-outline-secondary me-2 download-chart-csv-button" data-chart-type="activityByHour" title="Descargar datos del gráfico (CSV)">
                            <i class="bi bi-download"></i> CSV
                        </button>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                </div>
                <div class="modal-body">
                    <div class="chart-container-modal">
                        <canvas id="activityByHourChartModal"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="activityByDayOfWeekModal" tabindex="-1" aria-labelledby="activityByDayOfWeekModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-fullscreen">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="activityByDayOfWeekModalLabel">Eventos por Día de la Semana (Detallado)</h5>
                    <div>
                        <button class="btn btn-sm btn-outline-secondary me-2 download-chart-csv-button" data-chart-type="activityByDayOfWeek" title="Descargar datos del gráfico (CSV)">
                            <i class="bi bi-download"></i> CSV
                        </button>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                </div>
                <div class="modal-body">
                    <div class="chart-container-modal">
                        <canvas id="activityByDayOfWeekChartModal"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="modal fade" id="componentBreakdownModal" tabindex="-1" aria-labelledby="componentBreakdownModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-fullscreen">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="componentBreakdownModalLabel">Desglose de Eventos en Componentes Principales (Detallado)</h5>
                    <div>
                        <button class="btn btn-sm btn-outline-secondary me-2 download-chart-csv-button" data-chart-type="componentBreakdown" title="Descargar datos del gráfico (CSV)">
                            <i class="bi bi-download"></i> CSV
                        </button>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                </div>
                <div class="modal-body">
                    <div class="chart-container-modal">
                        <canvas id="componentBreakdownChartModal"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="activityByContextModal" tabindex="-1" aria-labelledby="activityByContextModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-fullscreen">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="activityByContextModalLabel">Actividad por Contexto de Evento (Detallado)</h5>
                    <div>
                        <button class="btn btn-sm btn-outline-secondary me-2 download-chart-csv-button" data-chart-type="activityByContext" title="Descargar datos del gráfico (CSV)">
                            <i class="bi bi-download"></i> CSV
                        </button>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                </div>
                <div class="modal-body">
                    <div class="chart-container-modal">
                        <canvas id="activityByContextChartModal"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="scatterUsersEventsDayModal" tabindex="-1" aria-labelledby="scatterUsersEventsDayModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-fullscreen">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="scatterUsersEventsDayModalLabel">Dispersión: Usuarios Únicos vs Eventos Totales (por Día)</h5>
                    <div>
                        <button class="btn btn-sm btn-outline-secondary me-2 download-chart-csv-button" data-chart-type="scatterUsersEventsDay" title="Descargar datos del gráfico (CSV)">
                            <i class="bi bi-download"></i> CSV
                        </button>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                </div>
                <div class="modal-body">
                    <div class="chart-container-modal">
                        <canvas id="scatterUsersEventsDayModalCanvas"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="scatterComponentsEventsUserModal" tabindex="-1" aria-labelledby="scatterComponentsEventsUserModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-fullscreen">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="scatterComponentsEventsUserModalLabel">Dispersión: Componentes Únicos vs Eventos Totales (por Alumno)</h5>
                    <div>
                        <button class="btn btn-sm btn-outline-secondary me-2 download-chart-csv-button" data-chart-type="scatterComponentsEventsUser" title="Descargar datos del gráfico (CSV)">
                            <i class="bi bi-download"></i> CSV
                        </button>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                </div>
                <div class="modal-body">
                    <div class="chart-container-modal">
                        <canvas id="scatterComponentsEventsUserModalCanvas"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="scatterContentViewParticipationModal" tabindex="-1" aria-labelledby="scatterContentViewParticipationModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-fullscreen">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="scatterContentViewParticipationModalLabel">Dispersión: Eventos de Visualización vs Participación (por Alumno)</h5>
                    <div>
                        <button class="btn btn-sm btn-outline-secondary me-2 download-chart-csv-button" data-chart-type="scatterContentViewParticipation" title="Descargar datos del gráfico (CSV)">
                            <i class="bi bi-download"></i> CSV
                        </button>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                </div>
                <div class="modal-body">
                    <div class="chart-container-modal">
                        <canvas id="scatterContentViewParticipationModalCanvas"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="bubbleStudentAnalysisModal" tabindex="-1" aria-labelledby="bubbleStudentAnalysisModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-fullscreen">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="bubbleStudentAnalysisModalLabel">Burbujas: Análisis de Alumnos</h5>
                    <div>
                        <button class="btn btn-sm btn-outline-secondary me-2 download-chart-csv-button" data-chart-type="bubbleStudentAnalysis" title="Descargar datos del gráfico (CSV)">
                            <i class="bi bi-download"></i> CSV
                        </button>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                </div>
                <div class="modal-body">
                    <div class="chart-container-modal">
                        <canvas id="bubbleStudentAnalysisModalCanvas"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="bubbleComponentAnalysisModal" tabindex="-1" aria-labelledby="bubbleComponentAnalysisModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-fullscreen">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="bubbleComponentAnalysisModalLabel">Burbujas: Análisis de Componentes</h5>
                    <div>
                        <button class="btn btn-sm btn-outline-secondary me-2 download-chart-csv-button" data-chart-type="bubbleComponentAnalysis" title="Descargar datos del gráfico (CSV)">
                            <i class="bi bi-download"></i> CSV
                        </button>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                </div>
                <div class="modal-body">
                    <div class="chart-container-modal">
                        <canvas id="bubbleComponentAnalysisModalCanvas"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="bubbleContextAnalysisModal" tabindex="-1" aria-labelledby="bubbleContextAnalysisModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-fullscreen">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="bubbleContextAnalysisModalLabel">Burbujas: Análisis de Contextos</h5>
                    <div>
                        <button class="btn btn-sm btn-outline-secondary me-2 download-chart-csv-button" data-chart-type="bubbleContextAnalysis" title="Descargar datos del gráfico (CSV)">
                            <i class="bi bi-download"></i> CSV
                        </button>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                </div>
                <div class="modal-body">
                    <div class="chart-container-modal">
                        <canvas id="bubbleContextAnalysisModalCanvas"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="topIPsByEventsModal" tabindex="-1" aria-labelledby="topIPsByEventsModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-fullscreen">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="topIPsByEventsModalLabel">Top IPs por Número de Eventos (Detallado)</h5>
                     <div>
                        <button class="btn btn-sm btn-outline-secondary me-2 download-chart-csv-button" data-chart-type="topIPsByEvents" title="Descargar datos del gráfico (CSV)">
                            <i class="bi bi-download"></i> CSV
                        </button>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                </div>
                <div class="modal-body">
                    <div class="chart-container-modal">
                        <canvas id="topIPsByEventsModalCanvas"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="usersPerIPModal" tabindex="-1" aria-labelledby="usersPerIPModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-fullscreen">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="usersPerIPModalLabel">Top IPs por Número de Alumnos Únicos (Detallado)</h5>
                    <div>
                        <button class="btn btn-sm btn-outline-secondary me-2 download-chart-csv-button" data-chart-type="usersPerIP" title="Descargar datos del gráfico (CSV)">
                            <i class="bi bi-download"></i> CSV
                        </button>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                </div>
                <div class="modal-body">
                    <div class="chart-container-modal">
                        <canvas id="usersPerIPModalCanvas"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="ipsPerUserModal" tabindex="-1" aria-labelledby="ipsPerUserModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-fullscreen">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="ipsPerUserModalLabel">Top Alumnos por Número de IPs Únicas (Detallado)</h5>
                    <div>
                        <button class="btn btn-sm btn-outline-secondary me-2 download-chart-csv-button" data-chart-type="ipsPerUser" title="Descargar datos del gráfico (CSV)">
                            <i class="bi bi-download"></i> CSV
                        </button>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                </div>
                <div class="modal-body">
                    <div class="chart-container-modal">
                        <canvas id="ipsPerUserModalCanvas"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>


    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js" integrity="sha384-C6RzsynM9kWDrMNeT87bh95OGNyZPhcTNXj1NW7RuBCsyN/o0jlpcV8Qyq46cDfL" crossorigin="anonymous"></script>
    <script>
        // --- GLOBAL VARIABLES ---
        let parsedDataCache = []; 
        let globallyProcessedDataForBaseLists = [];
        let filteredDataForCharts = [];
        let areFiltersPopulated = false;
        let ipColumnAvailable = false;
        let includeZeroActivity = false;
        
        let excludedUserSubstrings = []; 
        let excludedComponentSubstrings = [];
        let excludedEventNameSubstrings = [];
        let excludedContextSubstrings = [];
        
        let VIEW_EVENT_PATTERNS = ["viewed", "view", "visto", "consulta", "course module viewed", "page viewed", "resource viewed", "url viewed", "book viewed", "lesson viewed", "folder viewed", "glossary entry viewed"];
        let PARTICIPATION_EVENT_PATTERNS = ["post created", "submitted", "attempt", "answered", "replied", "updated", "created", "participated", "added", "deleted", "enviado", "intento", "respondido", "actualizado", "creado", "participado", "añadido", "eliminado", "publicado", "forum discussion created", "quiz attempt submitted", "assignment submitted", "choice made", "feedback completed", "workshop assessment evaluated", "database record created", "wiki page created"];

        let dashUserActivityChartInstance = null;
        let dashEventsOverTimeChartInstance = null;
        let dashComponentActivityChartInstance = null;
        let dashActivityByHourChartInstance = null;
        let dashActivityByDayOfWeekChartInstance = null;
        let dashComponentBreakdownChartInstance = null;
        let dashActivityByContextChartInstance = null;
        let dashScatterUsersEventsDayInstance = null;
        let dashScatterComponentsEventsUserInstance = null;
        let dashScatterContentViewParticipationInstance = null;
        let dashBubbleStudentAnalysisInstance = null;
        let dashBubbleComponentAnalysisInstance = null;
        let dashBubbleContextAnalysisInstance = null;
        let dashTopIPsByEventsInstance = null;
        let dashUsersPerIPInstance = null;
        let dashIPsPerUserInstance = null;
        
        let modalChartInstance = null; 

        const CSV_COLUMN_MAPPING = {
            TIME: "Hora",
            FULL_NAME: "Nombre completo del usuario",
            AFFECTED_USER: "Usuario afectado", 
            EVENT_CONTEXT: "Contexto del evento",
            COMPONENT: "Componente",
            EVENT_NAME: "Nombre evento",
            DESCRIPTION: "Descripción",
            ORIGIN: "Origen",
            IP_ADDRESS: "Dirección IP"
        };
        
        // --- DOM Elements ---
        const csvFileInput = document.getElementById('csvFile');
        const startDateInput = document.getElementById('startDate');
        const endDateInput = document.getElementById('endDate');
        const startTimeFilter = document.getElementById('startTimeFilter');
        const endTimeFilter = document.getElementById('endTimeFilter');  
        const userFilterSelect = document.getElementById('userFilter');
        const eventFilterSelect = document.getElementById('eventFilter');
        const componentFilterSelect = document.getElementById('componentFilter'); 
        const contextFilterSelect = document.getElementById('contextFilter');
        const ipFilterSelect = document.getElementById('ipFilter');
        const ipFilterHelpText = document.getElementById('ipFilterHelp');
        const analyzeButton = document.getElementById('analyzeButton');
        const statusMessage = document.getElementById('statusMessage');
        const resultsSection = document.getElementById('resultsSection');
        const loadingIndicator = document.getElementById('loadingIndicator');
        const includeZeroActivitySwitch = document.getElementById('includeZeroActivitySwitch');
        
        const excludedUsernamesTextarea = document.getElementById('excludedUsernamesTextarea');
        const excludedComponentsTextarea = document.getElementById('excludedComponentsTextarea');
        const excludedEventNamesTextarea = document.getElementById('excludedEventNamesTextarea');
        const excludedContextsTextarea = document.getElementById('excludedContextsTextarea');
        
        const viewEventPatternsTextarea = document.getElementById('viewEventPatternsTextarea');
        const participationEventPatternsTextarea = document.getElementById('participationEventPatternsTextarea');
        const saveSettingsButton = document.getElementById('saveSettingsButton');

        const dashDateRangeEl = document.getElementById('dashDateRange');
        const dashTotalEventsEl = document.getElementById('dashTotalEvents');
        const dashUniqueUsersEl = document.getElementById('dashUniqueUsers');
        const dashActiveDaysEl = document.getElementById('dashActiveDays');
        const dashAvgEventsPerDayEl = document.getElementById('dashAvgEventsPerDay');
        const dashMostFrequentEventNameEl = document.getElementById('dashMostFrequentEventName');
        const dashMostFrequentComponentEl = document.getElementById('dashMostFrequentComponent');
        const dashMostActiveUserEl = document.getElementById('dashMostActiveUser');
        
        const logTableBody = document.getElementById('logTableBody');
        const tableRowCountEl = document.getElementById('tableRowCount');

        Chart.defaults.font.family = "system-ui, -apple-system, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, 'Noto Sans', 'Liberation Sans', sans-serif, 'Apple Color Emoji', 'Segoe UI Emoji', 'Segoe UI Symbol', 'Noto Color Emoji'";
        Chart.defaults.plugins.legend.position = 'bottom';
        Chart.defaults.plugins.tooltip.backgroundColor = 'rgba(0,0,0,0.8)';
        Chart.defaults.plugins.tooltip.multiKeyBackground = '#000';
        Chart.defaults.plugins.tooltip.titleFont = { size: 14, weight: 'bold'};
        Chart.defaults.plugins.tooltip.bodyFont = { size: 12 };
        Chart.defaults.scale.ticks.font = { size: 10 };
        Chart.defaults.scale.title.font = { size: 12, weight: '500' };
        Chart.defaults.scale.title.display = true;


        // --- Contenido de Ayuda para los Modales ---
        const helpContent = {
            generalStats: {
                title: "Ayuda: Estadísticas Generales",
                content: `
                    <h4>Descripción</h4>
                    <p>Este panel proporciona un resumen cuantitativo de los datos de logs Moodle una vez aplicados los filtros seleccionados y las exclusiones globales. Muestra métricas clave sobre la actividad general.</p>
                    <h4>Utilidad</h4>
                    <p>Ofrece una visión rápida del volumen y las características principales de la interacción en la plataforma dentro del periodo y con los filtros especificados. Es el punto de partida para entender la magnitud de los datos que se están analizando.</p>
                    <h4>Interpretación y Casos de Uso</h4>
                    <ul>
                        <li><strong>Rango de Fechas:</strong> Confirma el periodo temporal exacto que cubren los datos mostrados. Útil para asegurar que se está analizando el intervalo deseado.</li>
                        <li><strong>Total Eventos:</strong> Número absoluto de interacciones (logs) registradas. Un número alto indica mucha actividad; uno bajo puede significar poca interacción real, filtros muy restrictivos o un periodo corto.</li>
                        <li><strong>Usuarios Únicos:</strong> Cantidad de alumnos distintos que generaron al menos un evento. Ayuda a entender el alcance de la participación.</li>
                        <li><strong>Días con Actividad:</strong> Número de días únicos dentro del rango seleccionado en los que se registró al menos un evento. Indica la dispersión temporal de la actividad.</li>
                        <li><strong>Promedio Eventos/Día:</strong> Total de eventos dividido por el número de días con actividad. Mide la intensidad media de la interacción diaria.</li>
                        <li><strong>Evento Más Frecuente:</strong> El tipo de acción o log más común (ej. "Curso visto", "Tarea enviada"). Da pistas sobre las interacciones predominantes.</li>
                        <li><strong>Componente Más Accedido:</strong> El módulo o herramienta de Moodle que registró más eventos (ej. "Foro", "Tarea", "Sistema"). Indica qué partes de la plataforma son más utilizadas.</li>
                        <li><strong>Usuario Más Activo:</strong> El alumno que generó la mayor cantidad de eventos. Puede ser útil para identificar alumnos muy participativos o, en algunos casos, actividad anómala.</li>
                    </ul>
                    <h4>Relación con otros gráficos</h4>
                    <p>Los valores de este panel son la base agregada de lo que se desglosa en otros gráficos. Por ejemplo, el "Total Eventos" se visualiza distribuido en el tiempo en "Eventos por Día". El "Usuario Más Activo" será probablemente la barra más larga en "Actividad por Alumno". Estas estadísticas generales sirven como un control de consistencia para los demás análisis visuales.</p>
                `
            },
            userActivity: {
                title: "Ayuda: Actividad por Alumno",
                content: `
                    <h4>Descripción</h4>
                    <p>Este gráfico de barras horizontales muestra el número total de eventos (interacciones) generados por cada alumno, ordenados de mayor a menor actividad. La vista del panel principal muestra un "Top N" (ej. Top 15) de los alumnos más activos. Al hacer clic en el gráfico, se abre un modal con la lista completa de alumnos y su actividad, si la opción "Incluir ítems con 0 actividad" está desmarcada, o todos los alumnos del dataset base si está marcada.</p>
                    <h4>Utilidad</h4>
                    <p>Permite identificar rápidamente a los alumnos más participativos y a aquellos con menor interacción en la plataforma. Es fundamental para detectar posibles problemas de participación o desvinculación.</p>
                    <h4>Interpretación y Casos de Uso</h4>
                    <ul>
                        <li><strong>Barras largas:</strong> Indican alumnos con alta frecuencia de interacción.</li>
                        <li><strong>Barras cortas (o ausentes si no se incluyen los de 0 actividad):</strong> Señalan alumnos con baja participación. Esto podría requerir una intervención pedagógica o tutoría.</li>
                        <li><strong>Identificar "outliers":</strong> Alumnos con actividad excepcionalmente alta o baja en comparación con el promedio del grupo.</li>
                        <li><strong>Seguimiento individualizado:</strong> Facilitar la detección de alumnos que podrían necesitar apoyo adicional.</li>
                        <li><strong>Gamificación/Reconocimiento:</strong> Identificar a los alumnos más activos para posibles reconocimientos (si aplica al contexto pedagógico).</li>
                        <li>Si "Incluir ítems con 0 actividad" está activo, se pueden ver todos los alumnos, incluso aquellos sin eventos en el periodo/filtros actuales, lo que es útil para ver una lista completa de participantes y su (falta de) actividad.</li>
                    </ul>
                    <h4>Relación con otros gráficos</h4>
                    <ul>
                        <li>Se relaciona directamente con el "Usuario Más Activo" de las <strong>Estadísticas Generales</strong>.</li>
                        <li>Se complementa con el gráfico de burbujas <strong>"Análisis Alumnos"</strong>, que ofrece una visión multidimensional (días activos, promedio de eventos/día, total de eventos) para entender mejor el perfil de actividad de cada alumno. Por ejemplo, un alumno puede tener muchos eventos (barra larga aquí) pero concentrados en pocos días (visible en el gráfico de burbujas).</li>
                        <li>Puede cruzarse con <strong>"Visualización vs Participación"</strong> para entender si la alta actividad de un alumno es más de consumo de contenido o de participación activa.</li>
                        <li>Comparar con <strong>"Top Alumnos por Nº IPs"</strong> para ver si un alumno muy activo accede desde muchas ubicaciones diferentes.</li>
                    </ul>
                `
            },
            eventsOverTime: {
                title: "Ayuda: Eventos por Día",
                content: `
                    <h4>Descripción</h4>
                    <p>Este gráfico de líneas muestra la evolución del número total de eventos (interacciones) registrados en la plataforma día a día, dentro del rango de fechas seleccionado.</p>
                    <h4>Utilidad</h4>
                    <p>Permite visualizar tendencias temporales en la actividad de los alumnos, identificar picos de interacción y periodos de baja actividad. Es útil para entender cómo se distribuye la participación a lo largo del curso o de un periodo específico.</p>
                    <h4>Interpretación y Casos de Uso</h4>
                    <ul>
                        <li><strong>Picos de actividad:</strong> Suelen coincidir con fechas importantes como entregas de tareas, exámenes, inicio de nuevos temas o anuncios relevantes. Analizar si los picos esperados ocurren.</li>
                        <li><strong>Valles o periodos de baja actividad:</strong> Pueden indicar fines de semana, periodos vacacionales, o momentos de menor carga de trabajo en el curso. Una baja actividad prolongada e inesperada podría ser una señal de alerta.</li>
                        <li><strong>Tendencias crecientes o decrecientes:</strong> Observar si la actividad aumenta o disminuye a lo largo del tiempo, lo que podría reflejar el compromiso de los alumnos.</li>
                        <li><strong>Correlacionar con eventos del curso:</strong> Superponer mentalmente las fechas de publicación de nuevo material, foros de debate, etc., para ver su impacto en la actividad.</li>
                        <li><strong>Evaluar el impacto de intervenciones:</strong> Si se realizó alguna acción para fomentar la participación, se podría observar un cambio en la tendencia después de esa fecha.</li>
                    </ul>
                    <h4>Relación con otros gráficos</h4>
                    <ul>
                        <li>El área bajo la curva (sumando los valores diarios) debería corresponder aproximadamente al "Total Eventos" mostrado en las <strong>Estadísticas Generales</strong> para el mismo rango de fechas.</li>
                        <li>Se complementa con <strong>"Eventos por Hora del Día"</strong> y <strong>"Eventos por Día de Semana"</strong> para obtener un perfil temporal más completo. Un pico en un día específico aquí puede analizarse en esos otros gráficos para ver a qué hora del día o qué día de la semana (si el pico abarca varios días) fue más intenso.</li>
                        <li>El gráfico de dispersión <strong>"Usuarios Únicos vs Eventos (por Día)"</strong> puede ayudar a entender si un pico de eventos en un día se debió a muchos usuarios participando o a pocos usuarios muy activos.</li>
                    </ul>
                `
            },
            componentActivity: {
                title: "Ayuda: Actividad por Componente",
                content: `
                    <h4>Descripción</h4>
                    <p>Este gráfico de dona (o tarta) muestra la proporción del número total de eventos que ocurren en cada tipo de componente de Moodle (ej. Foro, Tarea, Cuestionario, Recurso, Sistema, etc.). El panel principal muestra los N componentes más utilizados.</p>
                    <h4>Utilidad</h4>
                    <p>Permite identificar qué tipos de herramientas o módulos de la plataforma Moodle son los más utilizados por los alumnos y cuáles generan mayor volumen de interacciones. Ayuda a entender en qué áreas de la plataforma se concentra la actividad.</p>
                    <h4>Interpretación y Casos de Uso</h4>
                    <ul>
                        <li><strong>Sectores grandes:</strong> Indican componentes con una alta proporción de la actividad total. Es importante verificar si estos coinciden con los componentes pedagógicamente más relevantes del curso.</li>
                        <li><strong>Sectores pequeños:</strong> Componentes con poca actividad. Podría ser porque no son centrales para el curso, los alumnos no los conocen, o no los encuentran útiles. Esto puede llevar a reflexionar sobre su diseño o promoción.</li>
                        <li><strong>Comparar cursos:</strong> Si se analizan varios cursos, se pueden comparar los patrones de uso de componentes.</li>
                        <li><strong>Rediseño de cursos:</strong> La información puede guiar decisiones sobre qué componentes potenciar o cuáles podrían necesitar alternativas si están infrautilizados.</li>
                        <li>Si "Incluir ítems con 0 actividad" está activo, se podrían ver componentes que existen en Moodle pero no tuvieron actividad en los datos filtrados (aunque en un gráfico de dona, los de 0 no suelen ser visibles a menos que sean los únicos datos).</li>
                    </ul>
                    <h4>Relación con otros gráficos</h4>
                    <ul>
                        <li>Se relaciona con "Componente Más Accedido" de las <strong>Estadísticas Generales</strong>.</li>
                        <li>El gráfico <strong>"Desglose Eventos en Componentes"</strong> profundiza esta visión, mostrando qué eventos específicos son los más comunes dentro de los componentes principales. Por ejemplo, este gráfico puede mostrar que "Foro" es muy usado, y el desglose mostraría si es por "ver mensajes" o por "crear discusiones".</li>
                        <li>El gráfico de burbujas <strong>"Análisis Componentes"</strong> ofrece otra perspectiva, considerando no solo el total de eventos (reflejado aquí), sino también el número de usuarios únicos por componente y el promedio de eventos por usuario en cada componente. Un componente puede tener muchos eventos (sector grande aquí) pero ser usado intensamente por pocos alumnos, o usado superficialmente por muchos.</li>
                    </ul>
                `
            },
            activityByHour: {
                title: "Ayuda: Eventos por Hora del Día",
                content: `
                    <h4>Descripción</h4>
                    <p>Este gráfico de barras verticales muestra el número total de eventos agrupados por cada hora del día, desde las 00:00 hasta las 23:00. Representa la distribución de la actividad a lo largo de un día típico.</p>
                    <h4>Utilidad</h4>
                    <p>Permite identificar los patrones horarios de actividad de los alumnos. Ayuda a entender en qué momentos del día se concentran las interacciones con la plataforma.</p>
                    <h4>Interpretación y Casos de Uso</h4>
                    <ul>
                        <li><strong>Picos horarios:</strong> Indican las horas de mayor actividad. Estos picos pueden variar según el perfil de los alumnos (ej. estudiantes a tiempo completo vs. trabajadores).</li>
                        <li><strong>Valles horarios:</strong> Horas de menor actividad, típicamente madrugada.</li>
                        <li><strong>Entender hábitos de estudio:</strong> ¿Los alumnos prefieren trabajar por la mañana, tarde o noche? Esto puede informar la programación de tutorías en línea, la publicación de anuncios importantes, o los horarios de mantenimiento.</li>
                        <li><strong>Detectar actividad inusual:</strong> Picos muy altos en horas normalmente inactivas podrían ser investigados, aunque pueden ser normales para algunos grupos.</li>
                        <li><strong>Adaptar estrategias de comunicación:</strong> Enviar recordatorios o mensajes importantes justo antes o durante los periodos de alta actividad podría mejorar su visibilidad.</li>
                    </ul>
                    <h4>Relación con otros gráficos</h4>
                    <ul>
                        <li>Complementa a <strong>"Eventos por Día"</strong> y <strong>"Eventos por Día de Semana"</strong> para construir un perfil temporal completo de la actividad. Si "Eventos por Día" muestra un pico el martes, este gráfico ayuda a ver si ese pico del martes fue por la mañana, tarde o noche.</li>
                        <li>Puede ser interesante cruzar esta información con el tipo de <strong>"Componente"</strong> o <strong>"Contexto"</strong> más accedido en esas horas pico, aunque este gráfico por sí solo no lo muestre.</li>
                    </ul>
                `
            },
             activityByDayOfWeek: {
                title: "Ayuda: Eventos por Día de Semana",
                content: `
                    <h4>Descripción</h4>
                    <p>Este gráfico de barras verticales muestra el número total de eventos agrupados por cada día de la semana, de Lunes a Domingo.</p>
                    <h4>Utilidad</h4>
                    <p>Permite identificar qué días de la semana son los más activos y cuáles registran menor interacción. Ayuda a comprender el ritmo semanal de trabajo de los alumnos en la plataforma.</p>
                    <h4>Interpretación y Casos de Uso</h4>
                    <ul>
                        <li><strong>Picos semanales:</strong> Indican los días de la semana con mayor concentración de actividad. Comúnmente, pueden ser los días previos a una entrega o durante los días laborables/lectivos.</li>
                        <li><strong>Actividad en fines de semana:</strong> Observar si hay una actividad significativa los sábados o domingos, lo que podría indicar que los alumnos dedican tiempo de estudio durante el fin de semana.</li>
                        <li><strong>Planificación de actividades:</strong> Si se observa que ciertos días son consistentemente bajos en actividad, se podría evitar programar entregas o eventos sincrónicos importantes para esos días, o viceversa, aprovechar los días de alta actividad.</li>
                        <li><strong>Comparar semanas:</strong> Aunque este gráfico agrega todos los días (ej. todos los lunes del periodo), si se filtra por semanas específicas, se pueden comparar patrones.</li>
                    </ul>
                    <h4>Relación con otros gráficos</h4>
                    <ul>
                        <li>Complementa a <strong>"Eventos por Día"</strong> y <strong>"Eventos por Hora del Día"</strong>. Un patrón general en "Eventos por Día" (ej. picos a mitad de mes) puede analizarse aquí para ver si esos picos caen consistentemente en ciertos días de la semana.</li>
                        <li>Si se combina con la información de <strong>"Actividad por Componente"</strong> (filtrando por días específicos, si la herramienta lo permitiera de forma avanzada), se podría ver si ciertos componentes se usan más en días específicos.</li>
                    </ul>
                `
            },
            componentBreakdown: {
                title: "Ayuda: Desglose Eventos en Componentes",
                content: `
                    <h4>Descripción</h4>
                    <p>Este gráfico de barras (generalmente agrupadas o apiladas, dependiendo de la configuración) muestra, para los N componentes más activos (eje X), los M eventos más frecuentes que ocurren dentro de cada uno de esos componentes. Cada color de barra o segmento representa un tipo de evento específico.</p>
                    <h4>Utilidad</h4>
                    <p>Va un paso más allá de "Actividad por Componente". No solo dice qué componentes son populares, sino *cómo* se están utilizando, es decir, qué acciones específicas (eventos) son las más comunes dentro de ellos.</p>
                    <h4>Interpretación y Casos de Uso</h4>
                    <ul>
                        <li><strong>Entender el uso detallado:</strong> Por ejemplo, si el componente "Foro" es muy activo, este gráfico puede mostrar si la mayoría de los eventos son "Usuario vio la discusión del foro" (consumo) o "Se creó la publicación en el foro" (participación).</li>
                        <li><strong>Identificar acciones clave:</strong> Para un componente "Tarea", se puede ver si predominan eventos como "Se ha visualizado el estado de la entrega" versus "Se ha enviado una entrega".</li>
                        <li><strong>Validar el diseño pedagógico:</strong> Si se espera que los alumnos realicen ciertas acciones en componentes específicos, este gráfico ayuda a verificar si eso está ocurriendo.</li>
                        <li><strong>Detectar cuellos de botella o confusión:</strong> Si un evento inesperado es muy frecuente en un componente (ej. muchos "error al subir archivo"), podría indicar un problema.</li>
                    </ul>
                    <h4>Relación con otros gráficos</h4>
                    <ul>
                        <li>Es una profundización directa de <strong>"Actividad por Componente"</strong>. Toma los componentes más activos de aquel y los desmenuza.</li>
                        <li>Puede dar contexto a los datos de <strong>"Visualización vs Participación"</strong>. Si un alumno tiene muchos eventos de visualización, este gráfico podría ayudar a identificar en qué componentes y con qué eventos específicos de visualización está interactuando.</li>
                        <li>La información de <strong>"Evento Más Frecuente"</strong> en Estadísticas Generales podría corresponder a una de las barras altas en este gráfico, dentro de su respectivo componente.</li>
                    </ul>
                `
            },
            activityByContext: {
                title: "Ayuda: Actividad por Contexto",
                content: `
                    <h4>Descripción</h4>
                    <p>Este gráfico de barras horizontales muestra el número total de eventos generados dentro de cada "Contexto del evento". Un contexto suele ser una instancia específica de un componente, como el nombre de un curso particular, el título de una tarea ("Tarea 1: Ensayo"), un foro específico ("Foro de Dudas Semana 3"), o una página de un libro. Muestra los N contextos más activos.</p>
                    <h4>Utilidad</h4>
                    <p>Permite identificar con gran detalle qué partes específicas del curso o qué actividades/recursos concretos están generando la mayor cantidad de interacciones. Es más granular que "Actividad por Componente".</p>
                    <h4>Interpretación y Casos de Uso</h4>
                    <ul>
                        <li><strong>Barras largas:</strong> Indican contextos (cursos específicos, actividades, recursos) con alta actividad.</li>
                        <li><strong>Identificar "hotspots":</strong> Encontrar las actividades o recursos más populares o que generan más "tráfico".</li>
                        <li><strong>Evaluar el engagement por actividad:</strong> Comparar la actividad entre diferentes tareas, foros, cuestionarios, etc.</li>
                        <li><strong>Detectar recursos infrautilizados:</strong> Contextos con muy baja actividad pueden necesitar revisión o promoción.</li>
                        <li><strong>Foco en problemas:</strong> Si un contexto de una actividad de evaluación tiene muchas vistas pero pocas entregas (requeriría cruzar con otros datos o eventos específicos), podría indicar dificultades.</li>
                        <li>Si "Incluir ítems con 0 actividad" está activo, puede mostrar todos los contextos definidos en los datos base, incluso aquellos sin actividad filtrada.</li>
                    </ul>
                    <h4>Relación con otros gráficos</h4>
                    <ul>
                        <li>Es más específico que <strong>"Actividad por Componente"</strong>. Un componente "Tarea" (visto en Actividad por Componente) puede tener múltiples contextos aquí, como "Tarea 1", "Tarea 2", etc.</li>
                        <li>Se complementa con el gráfico de burbujas <strong>"Análisis Contextos"</strong>, que añade dimensiones como el número de alumnos activos por contexto y el promedio de eventos por alumno, ofreciendo una visión más rica de la interacción en cada contexto.</li>
                        <li>Puede ayudar a entender los picos en <strong>"Eventos por Día"</strong>. Si hay un pico, mirar aquí qué contextos fueron los más activos en ese periodo puede explicarlo.</li>
                    </ul>
                `
            },
            scatterUsersEventsDay: {
                title: "Ayuda: Usuarios Únicos vs Eventos (por Día)",
                content: `
                    <h4>Descripción</h4>
                    <p>Este es un gráfico de dispersión donde cada punto representa un día dentro del periodo filtrado.
                    <ul>
                        <li><strong>Eje X (Horizontal):</strong> Número de usuarios (alumnos) únicos que tuvieron actividad ese día.</li>
                        <li><strong>Eje Y (Vertical):</strong> Número total de eventos (interacciones) registrados ese día.</li>
                    </ul>
                    </p>
                    <h4>Utilidad</h4>
                    <p>Ayuda a analizar la relación entre la cantidad de participantes distintos y la intensidad de su participación agregada en base diaria. Permite identificar diferentes "perfiles" de días.</p>
                    <h4>Interpretación y Casos de Uso</h4>
                    <ul>
                        <li><strong>Puntos en el cuadrante superior derecho:</strong> Días con muchos usuarios únicos Y muchos eventos. Generalmente, días de alta actividad y amplio alcance.</li>
                        <li><strong>Puntos en el cuadrante superior izquierdo:</strong> Días con pocos usuarios únicos PERO muchos eventos. Indica que unos pocos usuarios fueron extremadamente activos ese día.</li>
                        <li><strong>Puntos en el cuadrante inferior derecho:</strong> Días con muchos usuarios únicos PERO pocos eventos totales. Sugiere una participación amplia pero superficial (muchos hicieron poco).</li>
                        <li><strong>Puntos en el cuadrante inferior izquierdo:</strong> Días con pocos usuarios únicos Y pocos eventos. Días de baja actividad general.</li>
                        <li><strong>Identificar patrones:</strong> ¿Hay una correlación positiva clara (más usuarios implican más eventos)? ¿Hay días atípicos?</li>
                        <li><strong>Entender la naturaleza de los picos:</strong> Si el gráfico "Eventos por Día" muestra un pico, este gráfico de dispersión ayuda a determinar si ese pico fue causado por muchos usuarios participando moderadamente o por pocos usuarios hiperactivos.</li>
                    </ul>
                    <h4>Relación con otros gráficos</h4>
                    <ul>
                        <li>Complementa directamente el gráfico <strong>"Eventos por Día"</strong>. Cada punto aquí corresponde a un valor diario de la línea en "Eventos por Día", pero añade la dimensión del número de usuarios únicos.</li>
                        <li>Si se observan días con pocos usuarios y muchos eventos, podría ser interesante ver quiénes fueron esos usuarios en <strong>"Actividad por Alumno"</strong> (filtrando por ese día específico si fuera posible con una herramienta más avanzada).</li>
                    </ul>
                `
            },
            scatterComponentsEventsUser: {
                title: "Ayuda: Componentes Únicos vs Eventos (por Alumno)",
                content: `
                    <h4>Descripción</h4>
                    <p>Este gráfico de dispersión muestra a cada alumno como un punto individual.
                    <ul>
                        <li><strong>Eje X (Horizontal):</strong> Número de componentes Moodle distintos con los que interactuó el alumno (ej. Foro, Tarea, Recurso son 3 componentes únicos).</li>
                        <li><strong>Eje Y (Vertical):</strong> Número total de eventos (interacciones) generados por ese alumno.</li>
                    </ul>
                    </p>
                    <h4>Utilidad</h4>
                    <p>Permite entender si los alumnos tienden a explorar una amplia variedad de componentes de la plataforma o si se concentran en unos pocos, y cómo esta amplitud de uso se relaciona con su volumen total de actividad.</p>
                    <h4>Interpretación y Casos de Uso</h4>
                    <ul>
                        <li><strong>Puntos en el cuadrante superior derecho:</strong> Alumnos que interactúan con muchos componentes diferentes Y tienen un alto número total de eventos. Son exploradores y activos.</li>
                        <li><strong>Puntos en el cuadrante superior izquierdo:</strong> Alumnos que interactúan con pocos componentes PERO tienen un alto número total de eventos. Son muy activos pero enfocados en áreas específicas.</li>
                        <li><strong>Puntos en el cuadrante inferior derecho:</strong> Alumnos que interactúan con muchos componentes PERO tienen un bajo número total de eventos. Son exploradores superficiales, "picotean" en muchos sitios sin profundizar.</li>
                        <li><strong>Puntos en el cuadrante inferior izquierdo:</strong> Alumnos que interactúan con pocos componentes Y tienen un bajo número total de eventos. Generalmente, baja actividad y poca exploración.</li>
                        <li><strong>Identificar perfiles de uso:</strong> Ayuda a segmentar alumnos según su comportamiento de navegación y participación.</li>
                    </ul>
                    <h4>Relación con otros gráficos</h4>
                    <ul>
                        <li>Complementa el gráfico <strong>"Actividad por Alumno"</strong>. Un alumno puede tener una barra larga (alta actividad) en "Actividad por Alumno", y este gráfico de dispersión mostrará si esa actividad se distribuye entre muchos componentes o se concentra en pocos.</li>
                        <li>Podría dar pistas para interpretar <strong>"Actividad por Componente"</strong>. Si un componente es muy usado (sector grande), este gráfico podría mostrar si son muchos alumnos usándolo un poco, o pocos alumnos usándolo mucho.</li>
                    </ul>
                `
            },
            scatterContentViewParticipation: {
                title: "Ayuda: Visualización vs Participación (por Alumno)",
                content: `
                    <h4>Descripción</h4>
                    <p>En este gráfico de dispersión, cada punto representa un alumno.
                    <ul>
                        <li><strong>Eje X (Horizontal):</strong> Número de eventos de "visualización" realizados por el alumno (ej. "curso visto", "recurso visto", "mensaje de foro leído"). Estos patrones se definen en la Configuración.</li>
                        <li><strong>Eje Y (Vertical):</strong> Número de eventos de "participación" realizados por el alumno (ej. "tarea enviada", "mensaje publicado en foro", "intento de cuestionario"). Estos patrones también se definen en la Configuración.</li>
                    </ul>
                    Un evento se cuenta como participación solo si coincide con los patrones de participación Y NO con los de visualización, para evitar doble conteo.
                    </p>
                    <h4>Utilidad</h4>
                    <p>Permite clasificar a los alumnos según su estilo predominante de interacción: ¿son principalmente "consumidores" de contenido (visualizadores) o "productores/colaboradores" activos (participantes)?</p>
                    <h4>Interpretación y Casos de Uso</h4>
                    <ul>
                        <li><strong>Puntos cerca de la diagonal (si X e Y tuvieran escalas similares):</strong> Alumnos con un equilibrio relativo entre visualizar y participar.</li>
                        <li><strong>Puntos predominantemente hacia el eje Y (arriba a la izquierda):</strong> Alumnos que participan más de lo que visualizan (en proporción). Son "hacedores".</li>
                        <li><strong>Puntos predominantemente hacia el eje X (abajo a la derecha):</strong> Alumnos que visualizan mucho más de lo que participan. A veces llamados "lurkers" o consumidores pasivos.</li>
                        <li><strong>Puntos en el cuadrante superior derecho:</strong> Alumnos activos tanto en visualización como en participación.</li>
                        <li><strong>Puntos en el cuadrante inferior izquierdo:</strong> Alumnos con baja actividad en general, tanto de visualización como de participación.</li>
                        <li><strong>Identificar alumnos pasivos:</strong> Aquellos con alta visualización pero baja participación podrían necesitar estrategias para fomentar su involucramiento activo.</li>
                        <li><strong>Evaluar si el consumo de contenido se traduce en acción:</strong> Idealmente, la visualización de recursos debería llevar a la participación en actividades.</li>
                    </ul>
                    <h4>Relación con otros gráficos</h4>
                    <ul>
                        <li>Profundiza el análisis de <strong>"Actividad por Alumno"</strong>. Un alumno puede ser "activo", pero este gráfico matiza si esa actividad es de un tipo u otro.</li>
                        <li>Puede relacionarse con <strong>"Desglose Eventos en Componentes"</strong>. Si un alumno es muy "visualizador", el desglose podría mostrar que está viendo muchos recursos o foros pero no interactuando en ellos.</li>
                        <li>La efectividad de este gráfico depende crucialmente de la correcta definición de los patrones de eventos de visualización y participación en la Configuración.</li>
                    </ul>
                `
            },
            bubbleStudentAnalysis: {
                title: "Ayuda: Análisis Alumnos (Burbujas)",
                content: `
                    <h4>Descripción</h4>
                    <p>Este gráfico de burbujas representa a cada alumno como una burbuja, permitiendo visualizar tres métricas simultáneamente:
                    <ul>
                        <li><strong>Eje X (Horizontal):</strong> Número de días distintos en que el alumno estuvo activo. Mide la <em>consistencia</em> o <em>frecuencia</em> de la actividad.</li>
                        <li><strong>Eje Y (Vertical):</strong> Promedio de eventos por día activo para ese alumno. Mide la <em>intensidad</em> de la actividad en los días que participa.</li>
                        <li><strong>Tamaño de la Burbuja (R):</strong> Número total de eventos del alumno. Mide el <em>volumen</em> total de actividad.</li>
                    </ul>
                    </p>
                    <h4>Utilidad</h4>
                    <p>Ofrece una visión multidimensional del comportamiento de cada alumno, permitiendo identificar diferentes perfiles de participación más allá del simple conteo total de eventos.</p>
                    <h4>Interpretación y Casos de Uso</h4>
                    <ul>
                        <li><strong>Burbujas grandes en la esquina superior derecha:</strong> Alumnos ideales: activos muchos días (consistentes), con alta intensidad en esos días, y un gran volumen total de actividad.</li>
                        <li><strong>Burbujas grandes, a la derecha pero bajas en Y:</strong> Alumnos activos muchos días (consistentes), pero con baja intensidad diaria (muchos días haciendo poco). Actividad constante pero superficial.</li>
                        <li><strong>Burbujas grandes, arriba pero a la izquierda en X:</strong> Alumnos activos pocos días, pero con muy alta intensidad en esos días (ráfagas de actividad). Actividad esporádica pero profunda.</li>
                        <li><strong>Burbujas pequeñas:</strong> Generalmente indican baja actividad en una o más dimensiones.</li>
                        <li><strong>Segmentación de alumnos:</strong> Identificar grupos de alumnos con perfiles similares para posibles intervenciones pedagógicas diferenciadas. Por ejemplo, animar a los de "ráfagas" a ser más constantes, o a los "superficiales" a profundizar.</li>
                        <li><strong>Detectar "sprinters vs. marathoners":</strong> Alumnos que trabajan intensamente en cortos periodos versus aquellos con un ritmo más constante y distribuido.</li>
                    </ul>
                    <h4>Relación con otros gráficos</h4>
                    <ul>
                        <li>Es una forma avanzada de visualizar los datos de <strong>"Actividad por Alumno"</strong> (que solo muestra el total de eventos, el tamaño de la burbuja aquí). Este gráfico añade las dimensiones de consistencia (días activos) e intensidad (eventos/día).</li>
                        <li>Puede ayudar a entender por qué un alumno aparece alto o bajo en <strong>"Actividad por Alumno"</strong>.</li>
                    </ul>
                `
            },
            bubbleComponentAnalysis: {
                title: "Ayuda: Análisis Componentes (Burbujas)",
                content: `
                    <h4>Descripción</h4>
                    <p>Cada burbuja en este gráfico representa un componente de Moodle (ej. Foro, Tarea, Cuestionario). Se visualizan tres métricas:
                    <ul>
                        <li><strong>Eje X (Horizontal):</strong> Número de usuarios únicos que interactuaron con el componente. Mide el <em>alcance</em> o <em>popularidad</em> del componente en términos de cuántos alumnos lo usan.</li>
                        <li><strong>Eje Y (Vertical):</strong> Número total de eventos registrados en ese componente. Mide el <em>volumen total de actividad</em> en el componente.</li>
                        <li><strong>Tamaño de la Burbuja (R):</strong> Promedio de eventos por usuario en ese componente (Total Eventos / Usuarios Únicos). Mide la <em>profundidad</em> o <em>intensidad de uso</em> por parte de quienes lo utilizan.</li>
                    </ul>
                    </p>
                    <h4>Utilidad</h4>
                    <p>Permite evaluar los componentes no solo por su volumen de actividad o número de usuarios, sino también por la intensidad con la que cada usuario interactúa con ellos. Ayuda a identificar qué componentes son ampliamente usados y/o profundamente utilizados.</p>
                    <h4>Interpretación y Casos de Uso</h4>
                    <ul>
                        <li><strong>Burbujas grandes (R) en la esquina superior derecha:</strong> Componentes "estrella": muchos usuarios los usan (alto X), generan muchos eventos en total (alto Y), y los usuarios que los usan interactúan intensamente con ellos (grande R).</li>
                        <li><strong>Burbujas arriba a la derecha, pero pequeñas (R):</strong> Componentes usados por muchos y con muchos eventos, pero cada usuario interactúa poco. Uso amplio pero superficial.</li>
                        <li><strong>Burbujas grandes (R) pero bajas en X y/o Y:</strong> Componentes que, aunque no sean usados por muchos o no generen un volumen masivo de eventos, los pocos que los usan lo hacen muy intensamente. Pueden ser herramientas especializadas o muy efectivas para un nicho.</li>
                        <li><strong>Identificar componentes clave:</strong> Aquellos que logran alto alcance y alta profundidad de uso.</li>
                        <li><strong>Evaluar el "engagement" por componente:</strong> ¿Hay componentes que, aunque no sean los más populares en cuanto a número de usuarios, generan mucha interacción por parte de quienes los acceden?</li>
                    </ul>
                    <h4>Relación con otros gráficos</h4>
                    <ul>
                        <li>Complementa <strong>"Actividad por Componente"</strong> (que típicamente muestra el total de eventos - eje Y aquí, o la proporción de ellos). Este gráfico añade las dimensiones de alcance (usuarios únicos) e intensidad de uso (eventos/usuario).</li>
                        <li>Si un componente tiene un sector grande en "Actividad por Componente", este gráfico de burbujas puede indicar si ese volumen se debe a muchos usuarios o a pocos usuarios muy activos.</li>
                    </ul>
                `
            },
            bubbleContextAnalysis: {
                title: "Ayuda: Análisis Contextos (Burbujas)",
                content: `
                    <h4>Descripción</h4>
                    <p>Similar al "Análisis Componentes", pero a un nivel más granular. Cada burbuja representa un contexto de evento específico (ej. "Tarea 1: Ensayo", "Foro de Dudas Semana 3", "Examen Parcial 1").
                    <ul>
                        <li><strong>Eje X (Horizontal):</strong> Número de alumnos activos distintos en ese contexto. Mide cuántos alumnos diferentes interactuaron con esa actividad/recurso específico.</li>
                        <li><strong>Eje Y (Vertical):</strong> Promedio de eventos por alumno activo en ese contexto. Mide la intensidad de la interacción de cada alumno con esa actividad/recurso.</li>
                        <li><strong>Tamaño de la Burbuja (R):</strong> Número total de eventos en ese contexto. Mide el volumen global de interacción con la actividad/recurso.</li>
                    </ul>
                    </p>
                    <h4>Utilidad</h4>
                    <p>Permite un análisis detallado de actividades o recursos específicos, evaluando su alcance entre los alumnos, la intensidad de la interacción que provocan, y el volumen total de actividad que generan.</p>
                    <h4>Interpretación y Casos de Uso</h4>
                    <ul>
                        <li><strong>Burbujas grandes (R) en la esquina superior derecha:</strong> Actividades/recursos "exitosos": muchos alumnos interactúan con ellos (alto X), lo hacen intensamente (alto Y), y generan mucho tráfico (grande R).</li>
                        <li><strong>Contextos con alto X pero bajo Y y R pequeño:</strong> Muchos alumnos acceden, pero interactúan poco. Podría ser una actividad de consulta rápida o una que no requiere mucha interacción.</li>
                        <li><strong>Contextos con bajo X pero alto Y y R grande o mediano:</strong> Pocos alumnos acceden, pero lo hacen muy intensamente. Podría ser una actividad opcional avanzada o una que engancha mucho a un grupo específico.</li>
                        <li><strong>Identificar las actividades más "enganchadoras":</strong> Aquellas que logran que los alumnos no solo las visiten, sino que interactúen repetida o profundamente.</li>
                        <li><strong>Comparar diferentes instancias de un mismo tipo de actividad:</strong> Ej. comparar "Tarea 1" vs "Tarea 2" en estas tres dimensiones.</li>
                    </ul>
                    <h4>Relación con otros gráficos</h4>
                    <ul>
                        <li>Es la versión multidimensional y detallada de <strong>"Actividad por Contexto"</strong> (que solo muestra el total de eventos - el tamaño de la burbuja aquí).</li>
                        <li>Si una actividad específica aparece con una barra larga en "Actividad por Contexto", este gráfico de burbujas detalla si esa actividad fue popular (muchos alumnos) y/o intensa (muchos eventos por alumno).</li>
                    </ul>
                `
            },
            topIPsByEvents: {
                title: "Ayuda: Top IPs por Número de Eventos",
                content: `
                    <h4>Descripción</h4>
                    <p>Este gráfico de barras horizontales muestra las N direcciones IP desde las cuales se originó el mayor número de eventos (interacciones) en la plataforma, dentro de los datos filtrados. Cada barra representa una dirección IP y su longitud es proporcional al total de eventos desde esa IP.</p>
                    <h4>Utilidad</h4>
                    <p>Sirve para identificar direcciones IP con una actividad inusualmente alta. Esto puede ser útil para detectar posibles problemas técnicos (ej. un script generando muchos logs), uso compartido de cuentas si no es una IP institucional, o para confirmar el acceso desde ubicaciones esperadas (ej. red del campus).</p>
                    <p><strong>Importante:</strong> Una dirección IP no identifica unívocamente a un usuario. Múltiples usuarios pueden compartir una IP (ej. en una red doméstica, un laboratorio, o detrás de un NAT). Un solo usuario también puede tener múltiples IPs si accede desde diferentes redes.</p>
                    <h4>Interpretación y Casos de Uso</h4>
                    <ul>
                        <li><strong>Barras muy largas:</strong> IPs con un volumen de actividad excepcionalmente alto.
                            <ul>
                                <li>Si la IP corresponde a la institución (ej. proxy del campus), es normal que tenga muchos eventos agregados de múltiples usuarios.</li>
                                <li>Si es una IP externa con muchísimos eventos, valdría la pena cruzar con otros datos. ¿Corresponde a un solo usuario muy activo o a múltiples usuarios? (Ver "Top IPs por N° Alumnos").</li>
                            </ul>
                        </li>
                        <li><strong>Detectar actividad anómala:</strong> Picos de eventos desde IPs desconocidas o inesperadas.</li>
                        <li><strong>Monitoreo de seguridad (básico):</strong> Aunque no es una herramienta de seguridad robusta, puede dar pistas sobre actividad automatizada (bots) si una IP genera un patrón de eventos muy repetitivo y masivo (requeriría análisis de logs detallado).</li>
                    </ul>
                    <h4>Relación con otros gráficos</h4>
                    <ul>
                        <li>Se complementa crucialmente con <strong>"Top IPs por N° Alumnos"</strong>. Si una IP está alta aquí (muchos eventos) y también alta en "Top IPs por N° Alumnos" (muchos usuarios), es probablemente una IP compartida común (ej. red institucional). Si está alta aquí pero baja en "N° Alumnos", significa que pocos usuarios (quizás uno) generaron muchos eventos desde esa IP.</li>
                        <li>También se relaciona con <strong>"Top Alumnos por N° IPs"</strong>. Si un alumno usa muchas IPs, y alguna de esas IPs también aparece aquí con alta actividad, se puede empezar a trazar un panorama más completo del acceso.</li>
                    </ul>
                    <p class="text-muted small"><em>Este gráfico solo se mostrará si la columna 'Dirección IP' está presente en el archivo CSV cargado.</em></p>
                `
            },
            usersPerIP: {
                title: "Ayuda: Top IPs por Número de Alumnos",
                content: `
                    <h4>Descripción</h4>
                    <p>Este gráfico de barras horizontales muestra las N direcciones IP desde las cuales accedió el mayor número de alumnos únicos distintos, dentro de los datos filtrados. La longitud de la barra indica cuántos alumnos diferentes usaron esa IP.</p>
                    <h4>Utilidad</h4>
                    <p>Ayuda a identificar las direcciones IP más comunes o compartidas entre los alumnos. Puede revelar si los alumnos acceden predominantemente desde la red institucional, desde ciertos proveedores de internet mayoritarios, o desde puntos de acceso compartidos.</p>
                    <p><strong>Importante:</strong> Una dirección IP no identifica unívocamente a un usuario. Múltiples usuarios pueden compartir una IP. Un solo usuario también puede tener múltiples IPs.</p>
                    <h4>Interpretación y Casos de Uso</h4>
                    <ul>
                        <li><strong>Barras largas:</strong> IPs utilizadas por una gran cantidad de alumnos distintos.
                            <ul>
                                <li>Es común que las IPs de la red del campus o de grandes proveedores de internet aparezcan altas.</li>
                                <li>Si una IP específica (ej. de un cibercafé o biblioteca pública) aparece muy alta, indica que es un punto de acceso popular para los alumnos.</li>
                            </ul>
                        </li>
                        <li><strong>Comparar con "Top IPs por N° Eventos":</strong>
                            <ul>
                                <li><strong>Alta aquí y alta en eventos:</strong> IP muy concurrida y con mucha actividad general (ej. red del campus).</li>
                                <li><strong>Alta aquí pero baja en eventos:</strong> Muchos alumnos la usan, pero cada uno genera poca actividad desde ella, o la usan esporádicamente.</li>
                            </ul>
                        </li>
                        <li><strong>Entender la infraestructura de acceso:</strong> Proporciona una idea de desde dónde se conectan mayoritariamente los alumnos.</li>
                    </ul>
                    <h4>Relación con otros gráficos</h4>
                    <ul>
                        <li>Es el complemento directo de <strong>"Top IPs por N° Eventos"</strong>. Analizar ambos gráficos conjuntamente da una imagen más clara del perfil de cada IP.</li>
                        <li>Si un alumno específico de <strong>"Top Alumnos por N° IPs"</strong> utiliza una IP que también aparece alta aquí, confirma que esa IP es un punto de acceso común para ese alumno y otros.</li>
                    </ul>
                    <p class="text-muted small"><em>Este gráfico solo se mostrará si la columna 'Dirección IP' está presente en el archivo CSV cargado.</em></p>
                `
            },
            ipsPerUser: {
                title: "Ayuda: Top Alumnos por Número de IPs",
                content: `
                    <h4>Descripción</h4>
                    <p>Este gráfico de barras horizontales muestra los N alumnos que han accedido a la plataforma desde el mayor número de direcciones IP únicas diferentes, según los datos filtrados. Cada barra representa un alumno y su longitud indica desde cuántas IPs distintas ha accedido.</p>
                    <h4>Utilidad</h4>
                    <p>Permite identificar a los alumnos con mayor "movilidad" de acceso, es decir, aquellos que se conectan desde múltiples redes o dispositivos. Esto puede ser normal (ej. acceso desde casa, móvil, biblioteca, campus), pero un número excesivamente alto de IPs para un solo alumno podría, en casos extremos y junto con otra evidencia, sugerir un posible uso compartido de cuenta (aunque este gráfico por sí solo no lo prueba).</p>
                    <h4>Interpretación y Casos de Uso</h4>
                    <ul>
                        <li><strong>Barras largas:</strong> Alumnos que han utilizado una variedad considerable de direcciones IP.
                            <ul>
                                <li><strong>Moderadamente largas:</strong> Puede ser normal (ej. 2-5 IPs) para alumnos que usan PC, laptop, móvil y se conectan desde casa y la universidad.</li>
                                <li><strong>Excesivamente largas:</strong> Un número muy alto de IPs (ej. 10+ en un periodo corto) podría ser inusual y merecer una observación más detallada si hay otras señales de alerta, pero con cautela, ya que las IPs dinámicas pueden cambiar frecuentemente para un mismo usuario.</li>
                            </ul>
                        </li>
                        <li><strong>Monitorear patrones de acceso:</strong> Entender la diversidad de puntos de acceso de los alumnos.</li>
                        <li><strong>No sacar conclusiones precipitadas:</strong> El uso de VPNs o IPs dinámicas puede inflar este número. Este gráfico es una pista, no una prueba definitiva de nada irregular.</li>
                    </ul>
                    <h4>Relación con otros gráficos</h4>
                    <ul>
                        <li>Complementa <strong>"Actividad por Alumno"</strong>. Un alumno muy activo podría serlo accediendo siempre desde la misma IP o desde muchas.</li>
                        <li>Si un alumno está alto aquí, se puede ver si alguna de las IPs que usa aparece en <strong>"Top IPs por N° Eventos"</strong> o <strong>"Top IPs por N° Alumnos"</strong> para entender mejor esos puntos de acceso.</li>
                        <li>Si un alumno tiene muchas IPs y además una actividad muy esporádica o patrones extraños en otros gráficos, podría (con mucha cautela) ser un indicador para una revisión más profunda, siempre respetando la privacidad.</li>
                    </ul>
                    <p class="text-muted small"><em>Este gráfico solo se mostrará si la columna 'Dirección IP' está presente en el archivo CSV cargado.</em></p>
                `
            }
        };
        // --- FIN Contenido de Ayuda ---


        // --- HELPER FUNCTIONS FOR CSV DOWNLOAD ---
        function generateDynamicFilename(baseName, type = 'data') {
            const date = new Date();
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            const hours = String(date.getHours()).padStart(2, '0');
            const minutes = String(date.getMinutes()).padStart(2, '0');
            const seconds = String(date.getSeconds()).padStart(2, '0');
            
            const cleanBaseName = baseName
                .normalize("NFD").replace(/[\u0300-\u036f]/g, "") 
                .replace(/[^\w\s-]/g, '') 
                .trim()
                .replace(/\s+/g, '_') 
                .toLowerCase();
            const finalBaseName = cleanBaseName.substring(0, 40);

            return `${finalBaseName}_${type}_${year}${month}${day}_${hours}${minutes}${seconds}.csv`;
        }

        function escapeCsvValue(value) {
            if (value === null || value === undefined) {
                return '';
            }
            let stringValue = String(value);
            if (stringValue.includes('"') || stringValue.includes(',') || stringValue.includes('\n') || stringValue.includes('\r')) {
                stringValue = stringValue.replace(/"/g, '""'); 
                return `"${stringValue}"`; 
            }
            return stringValue;
        }

        function convertToCSV(dataArray, headers = null) {
            let csvString = '';
            
            if (dataArray.length > 0 && typeof dataArray[0] === 'object' && !Array.isArray(dataArray[0]) && !headers) {
                headers = Object.keys(dataArray[0]);
            }

            if (headers) {
                csvString += headers.map(header => escapeCsvValue(header)).join(',') + '\r\n';
            }

            dataArray.forEach(row => {
                let line;
                if (Array.isArray(row)) {
                    line = row.map(value => escapeCsvValue(value)).join(',');
                } else if (typeof row === 'object' && row !== null && headers) {
                    line = headers.map(header => escapeCsvValue(row[header])).join(',');
                } else {
                    line = escapeCsvValue(row);
                }
                csvString += line + '\r\n';
            });
            return csvString;
        }

        function downloadCSV(csvContent, filename) {
            const blob = new Blob(["\uFEFF" + csvContent], { type: 'text/csv;charset=utf-8;' }); // BOM for Excel
            const link = document.createElement("a");
            if (link.download !== undefined) {
                const url = URL.createObjectURL(blob);
                link.setAttribute("href", url);
                link.setAttribute("download", filename);
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                URL.revokeObjectURL(url);
            } else {
                navigator.msSaveBlob(blob, filename);
            }
        }


        document.addEventListener('DOMContentLoaded', () => {
            setDefaultDates();
            setDefaultTimes();
            loadSettings(); 
            
            analyzeButton.addEventListener('click', handleAnalysisRequest);
            csvFileInput.addEventListener('change', handleFileSelectionChange);
            saveSettingsButton.addEventListener('click', handleSaveSettings);
            includeZeroActivitySwitch.addEventListener('change', handleIncludeZeroActivityChange);
            
            const reprocessAndDisplay = () => { if (parsedDataCache.length > 0) processAndDisplayData(parsedDataCache); };
            startDateInput.addEventListener('change', reprocessAndDisplay);
            endDateInput.addEventListener('change', reprocessAndDisplay);
            startTimeFilter.addEventListener('change', reprocessAndDisplay);
            endTimeFilter.addEventListener('change', reprocessAndDisplay);  
            userFilterSelect.addEventListener('change', reprocessAndDisplay);
            eventFilterSelect.addEventListener('change', reprocessAndDisplay);
            componentFilterSelect.addEventListener('change', reprocessAndDisplay); 
            contextFilterSelect.addEventListener('change', reprocessAndDisplay);
            ipFilterSelect.addEventListener('change', reprocessAndDisplay);

            document.getElementById('currentYear').textContent = new Date().getFullYear();
            
            // --- Modal de Ayuda ---
            const helpModalInstance = new bootstrap.Modal(document.getElementById('helpModal'));
            const helpModalTitleEl = document.getElementById('helpModalTitle');
            const helpModalBodyEl = document.getElementById('helpModalBody');

            document.body.addEventListener('click', function(event) {
                const helpButton = event.target.closest('.help-button');
                if (helpButton) {
                    event.preventDefault(); // Prevenir cualquier otra acción si el botón está dentro de otro elemento clickeable
                    event.stopPropagation(); // Detener la propagación para no disparar el click del chart-card
                    
                    const chartHelpType = helpButton.dataset.chartHelpType;
                    const contentData = helpContent[chartHelpType];

                    if (contentData) {
                        helpModalTitleEl.textContent = contentData.title;
                        helpModalBodyEl.innerHTML = contentData.content;
                    } else {
                        helpModalTitleEl.textContent = "Ayuda no disponible";
                        helpModalBodyEl.innerHTML = "<p>El contenido de ayuda para este elemento aún no ha sido configurado.</p>";
                    }
                    helpModalInstance.show();
                    return; // Importante para no seguir con el código de abrir modal de gráfico
                }

                const chartCard = event.target.closest('.chart-card');
                 if (chartCard) {
                    const modalTargetId = chartCard.dataset.modalTarget;
                    const chartType = chartCard.dataset.chartType;
                    
                    const modalElement = document.querySelector(modalTargetId);
                    if (!modalElement) {
                        console.error('Modal target not found:', modalTargetId);
                        return;
                    }

                    const bootstrapModal = bootstrap.Modal.getInstance(modalElement) || new bootstrap.Modal(modalElement);
                    
                    const canvasIdInModal = modalElement.querySelector('canvas').id;
                    renderChartInModal(chartType, canvasIdInModal);
                    
                    bootstrapModal.show();
                }

                const downloadButton = event.target.closest('.download-chart-csv-button');
                if (downloadButton) {
                    event.preventDefault(); 
                    const modal = downloadButton.closest('.modal');
                    if (modal) {
                        const canvasInModal = modal.querySelector('.modal-body canvas');
                        if (canvasInModal && canvasInModal._chartjs) { 
                            const chartInstance = canvasInModal._chartjs;
                            const chartType = downloadButton.dataset.chartType; 
                            handleDownloadChartCsv(chartInstance, chartType, modal.id);
                        } else if (modalChartInstance && canvasInModal && modalChartInstance.canvas.id === canvasInModal.id) {
                            const chartType = downloadButton.dataset.chartType;
                            handleDownloadChartCsv(modalChartInstance, chartType, modal.id);
                        } else {
                            console.error("Could not find chart instance for modal:", modal.id);
                            showUserMessage("Error: No se pudo obtener los datos del gráfico para descargar.", "danger");
                        }
                    }
                }
            });


            const downloadLogsCsvButton = document.getElementById('downloadLogsCsvButton');
            if (downloadLogsCsvButton) {
                downloadLogsCsvButton.addEventListener('click', handleDownloadLogsCsv);
            }

            ipFilterSelect.disabled = true;
            ipFilterHelpText.textContent = "Cargue un archivo CSV con columna de IP para activar este filtro.";
        });

        function setDefaultDates() {
            const today = new Date();
            const currentYear = today.getFullYear();
            const currentMonth = today.getMonth(); 

            const firstDayOfMonth = new Date(currentYear, currentMonth, 1);
            const lastDayOfMonth = new Date(currentYear, currentMonth + 1, 0); 

            startDateInput.valueAsDate = firstDayOfMonth;
            endDateInput.valueAsDate = lastDayOfMonth;
        }

        function setDefaultTimes() {
            if (startTimeFilter) startTimeFilter.value = "00:00";
            if (endTimeFilter) endTimeFilter.value = "23:59";
        }
        
        function handleFileSelectionChange(event) {
            const file = event.target.files[0];
            if (file) {
                statusMessage.textContent = `Archivo seleccionado: ${file.name}. Listo para analizar.`;
                statusMessage.className = 'mt-3 pt-2 border-top text-info';
                parsedDataCache = []; 
                globallyProcessedDataForBaseLists = [];
                filteredDataForCharts = [];
                areFiltersPopulated = false; 
                ipColumnAvailable = false;
                resetFilterSelects(); 
                destroyAllDashboardCharts(); 
                clearDashboardStats();
                logTableBody.innerHTML = '';
                tableRowCountEl.textContent = '';
                resultsSection.classList.add('hidden'); 
            } else {
                statusMessage.textContent = 'Ningún archivo seleccionado.';
                statusMessage.className = 'mt-3 pt-2 border-top text-muted';
            }
        }
        
        function processExclusionText(text) {
            return text ? text.split(',').map(s => s.trim().toLowerCase()).filter(s => s) : [];
        }

        function handleSaveSettings() {
            excludedUserSubstrings = processExclusionText(excludedUsernamesTextarea.value);
            localStorage.setItem('moodleViewerExclusionsUsers', JSON.stringify(excludedUserSubstrings));

            excludedComponentSubstrings = processExclusionText(excludedComponentsTextarea.value);
            localStorage.setItem('moodleViewerExclusionsComponents', JSON.stringify(excludedComponentSubstrings));

            excludedEventNameSubstrings = processExclusionText(excludedEventNamesTextarea.value);
            localStorage.setItem('moodleViewerExclusionsEventNames', JSON.stringify(excludedEventNameSubstrings));

            excludedContextSubstrings = processExclusionText(excludedContextsTextarea.value);
            localStorage.setItem('moodleViewerExclusionsContexts', JSON.stringify(excludedContextSubstrings));

            const viewPatternsText = viewEventPatternsTextarea.value.trim();
            VIEW_EVENT_PATTERNS = viewPatternsText ? viewPatternsText.split(',').map(s => s.trim().toLowerCase()).filter(s => s) : [];
            localStorage.setItem('moodleViewerPatternsView', JSON.stringify(VIEW_EVENT_PATTERNS));

            const participationPatternsText = participationEventPatternsTextarea.value.trim();
            PARTICIPATION_EVENT_PATTERNS = participationPatternsText ? participationPatternsText.split(',').map(s => s.trim().toLowerCase()).filter(s => s) : [];
            localStorage.setItem('moodleViewerPatternsParticipation', JSON.stringify(PARTICIPATION_EVENT_PATTERNS));

            const settingsModalEl = document.getElementById('settingsModal');
            const modalInstance = bootstrap.Modal.getInstance(settingsModalEl);
            if (modalInstance) {
                modalInstance.hide();
            }

            if (parsedDataCache.length > 0) {
                showUserMessage('Configuración guardada. Reanalizando...', 'info');
                areFiltersPopulated = false; 
                globallyProcessedDataForBaseLists = applyGlobalExclusions(parsedDataCache);
                processAndDisplayData(parsedDataCache);
            } else {
                showUserMessage('Configuración guardada. Carga un archivo para ver los cambios.', 'info');
            }
        }

        function loadSettings() {
            const savedUserExclusions = localStorage.getItem('moodleViewerExclusionsUsers');
            if (savedUserExclusions) {
                excludedUserSubstrings = JSON.parse(savedUserExclusions);
                excludedUsernamesTextarea.value = excludedUserSubstrings.join(', ');
            }

            const savedComponentExclusions = localStorage.getItem('moodleViewerExclusionsComponents');
            if (savedComponentExclusions) {
                excludedComponentSubstrings = JSON.parse(savedComponentExclusions);
                excludedComponentsTextarea.value = excludedComponentSubstrings.join(', ');
            }

            const savedEventNameExclusions = localStorage.getItem('moodleViewerExclusionsEventNames');
            if (savedEventNameExclusions) {
                excludedEventNameSubstrings = JSON.parse(savedEventNameExclusions);
                excludedEventNamesTextarea.value = excludedEventNameSubstrings.join(', ');
            }

            const savedContextExclusions = localStorage.getItem('moodleViewerExclusionsContexts');
            if (savedContextExclusions) {
                excludedContextSubstrings = JSON.parse(savedContextExclusions);
                excludedContextsTextarea.value = excludedContextSubstrings.join(', ');
            }

            const savedViewPatterns = localStorage.getItem('moodleViewerPatternsView');
            if (savedViewPatterns) {
                VIEW_EVENT_PATTERNS = JSON.parse(savedViewPatterns);
            }
            viewEventPatternsTextarea.value = VIEW_EVENT_PATTERNS.join(', ');


            const savedParticipationPatterns = localStorage.getItem('moodleViewerPatternsParticipation');
            if (savedParticipationPatterns) {
                PARTICIPATION_EVENT_PATTERNS = JSON.parse(savedParticipationPatterns);
            }
            participationEventPatternsTextarea.value = PARTICIPATION_EVENT_PATTERNS.join(', ');

            const savedIncludeZeroActivity = localStorage.getItem('moodleViewerIncludeZeroActivity');
            if (savedIncludeZeroActivity !== null) {
                includeZeroActivity = JSON.parse(savedIncludeZeroActivity);
                includeZeroActivitySwitch.checked = includeZeroActivity;
            } else {
                 includeZeroActivitySwitch.checked = false; 
                 includeZeroActivity = false;
            }
        }

        function handleIncludeZeroActivityChange() {
            includeZeroActivity = includeZeroActivitySwitch.checked;
            localStorage.setItem('moodleViewerIncludeZeroActivity', JSON.stringify(includeZeroActivity));
            if (parsedDataCache.length > 0) {
                showUserMessage('Ajuste de visualización de ceros cambiado. Reanalizando...', 'info');
                showLoading(true);
                setTimeout(() => {
                    processAndDisplayData(parsedDataCache); 
                    showLoading(false);
                }, 50);
            }
        }

        function resetFilterSelects() {
            userFilterSelect.innerHTML = '<option value="ALL_USERS">Todos los Alumnos</option>';
            eventFilterSelect.innerHTML = '<option value="ALL_EVENTS">Todos los Eventos</option>';
            componentFilterSelect.innerHTML = '<option value="ALL_COMPONENTS">Todos los Componentes</option>'; 
            contextFilterSelect.innerHTML = '<option value="ALL_CONTEXTS">Todos los Contextos</option>';
            ipFilterSelect.innerHTML = '';
            ipFilterSelect.disabled = true;
            ipFilterHelpText.textContent = "Cargue un archivo CSV con columna de IP para activar este filtro.";
            setDefaultTimes();
        }

        function clearDashboardStats() {
            dashDateRangeEl.textContent = 'N/A';
            dashTotalEventsEl.textContent = 'N/A';
            dashUniqueUsersEl.textContent = 'N/A';
            dashActiveDaysEl.textContent = 'N/A';
            dashAvgEventsPerDayEl.textContent = 'N/A';
            dashMostFrequentEventNameEl.textContent = 'N/A';
            dashMostFrequentComponentEl.textContent = 'N/A';
            dashMostActiveUserEl.textContent = 'N/A';
        }

        function destroyAllDashboardCharts() {
            if (dashUserActivityChartInstance) { dashUserActivityChartInstance.destroy(); dashUserActivityChartInstance = null; }
            if (dashEventsOverTimeChartInstance) { dashEventsOverTimeChartInstance.destroy(); dashEventsOverTimeChartInstance = null; }
            if (dashComponentActivityChartInstance) { dashComponentActivityChartInstance.destroy(); dashComponentActivityChartInstance = null; }
            if (dashActivityByHourChartInstance) { dashActivityByHourChartInstance.destroy(); dashActivityByHourChartInstance = null; }
            if (dashActivityByDayOfWeekChartInstance) { dashActivityByDayOfWeekChartInstance.destroy(); dashActivityByDayOfWeekChartInstance = null; }
            if (dashComponentBreakdownChartInstance) { dashComponentBreakdownChartInstance.destroy(); dashComponentBreakdownChartInstance = null; }
            if (dashActivityByContextChartInstance) { dashActivityByContextChartInstance.destroy(); dashActivityByContextChartInstance = null; }
            
            if (dashScatterUsersEventsDayInstance) { dashScatterUsersEventsDayInstance.destroy(); dashScatterUsersEventsDayInstance = null; }
            if (dashScatterComponentsEventsUserInstance) { dashScatterComponentsEventsUserInstance.destroy(); dashScatterComponentsEventsUserInstance = null; }
            if (dashScatterContentViewParticipationInstance) { dashScatterContentViewParticipationInstance.destroy(); dashScatterContentViewParticipationInstance = null; }
            if (dashBubbleStudentAnalysisInstance) { dashBubbleStudentAnalysisInstance.destroy(); dashBubbleStudentAnalysisInstance = null; }
            if (dashBubbleComponentAnalysisInstance) { dashBubbleComponentAnalysisInstance.destroy(); dashBubbleComponentAnalysisInstance = null; }
            if (dashBubbleContextAnalysisInstance) { dashBubbleContextAnalysisInstance.destroy(); dashBubbleContextAnalysisInstance = null; }
            
            if (dashTopIPsByEventsInstance) { dashTopIPsByEventsInstance.destroy(); dashTopIPsByEventsInstance = null; }
            if (dashUsersPerIPInstance) { dashUsersPerIPInstance.destroy(); dashUsersPerIPInstance = null; }
            if (dashIPsPerUserInstance) { dashIPsPerUserInstance.destroy(); dashIPsPerUserInstance = null; }

            let canvasIds = [
                'dashUserActivityChart', 'dashEventsOverTimeChart', 'dashComponentActivityChart',
                'dashActivityByHourChart', 'dashActivityByDayOfWeekChart', 'dashComponentBreakdownChart', 'dashActivityByContextChart',
                'dashScatterUsersEventsDayChart', 'dashScatterComponentsEventsUserChart', 'dashScatterContentViewParticipationChart',
                'dashBubbleStudentAnalysisChart', 'dashBubbleComponentAnalysisChart', 'dashBubbleContextAnalysisChart',
                'dashTopIPsByEventsChart', 'dashUsersPerIPChart', 'dashIPsPerUserChart'
            ];
            canvasIds.forEach(id => {
                const canvas = document.getElementById(id);
                if (canvas) {
                    const ctx = canvas.getContext('2d');
                    ctx.clearRect(0, 0, canvas.width, canvas.height);
                }
            });
        }

        async function handleAnalysisRequest() {
            const file = csvFileInput.files[0];
            
            if (parsedDataCache.length > 0 && file === undefined) { 
                showLoading(true);
                await new Promise(resolve => setTimeout(resolve, 50)); 
                processAndDisplayData(parsedDataCache);
                showLoading(false);
                return;
            }
            
            if (!file) {
                showUserMessage("Por favor, selecciona un archivo CSV.", "danger");
                resultsSection.classList.add('hidden');
                return;
            }
            
            showLoading(true);
            showUserMessage('Leyendo y parseando archivo...', 'info');
            resultsSection.classList.add('hidden'); 
            
            if(resultsSection.classList.contains('hidden')) {
                destroyAllDashboardCharts();
                clearDashboardStats();
            }
            
            parsedDataCache = []; 
            globallyProcessedDataForBaseLists = [];
            filteredDataForCharts = [];
            areFiltersPopulated = false; 
            ipColumnAvailable = false;
            resetFilterSelects();

            try {
                const csvText = await readFileAsText(file);
                parsedDataCache = parseCSV(csvText);

                if (!parsedDataCache || parsedDataCache.length === 0) {
                    showUserMessage("No se pudieron procesar datos del CSV o el archivo está vacío.", "danger");
                    csvFileInput.value = ""; 
                    parsedDataCache = [];
                    resultsSection.classList.add('hidden');
                    return;
                }

                globallyProcessedDataForBaseLists = applyGlobalExclusions(parsedDataCache);

                if (parsedDataCache.length > 0 && parsedDataCache[0].hasOwnProperty('IP_ADDRESS')) {
                    ipColumnAvailable = true; 
                    ipFilterSelect.disabled = false;
                    ipFilterHelpText.textContent = "Seleccione una o más IPs. Ninguna selección implica todas.";
                } else {
                    ipColumnAvailable = false;
                    ipFilterSelect.disabled = true;
                    ipFilterHelpText.textContent = "Columna 'Dirección IP' no encontrada en el archivo.";
                }
                
                processAndDisplayData(parsedDataCache);
                resultsSection.classList.remove('hidden');

            } catch (error) {
                console.error("Error durante el análisis:", error);
                showUserMessage(`Error al procesar el archivo: ${error.message}. Revisa la consola.`, "danger");
                parsedDataCache = [];
                globallyProcessedDataForBaseLists = [];
                csvFileInput.value = ""; 
                resultsSection.classList.add('hidden');
            } finally {
                showLoading(false);
            }
        }
        
        function showLoading(isLoading) {
            const controls = [
                csvFileInput, startDateInput, endDateInput, startTimeFilter, endTimeFilter,
                userFilterSelect, eventFilterSelect, componentFilterSelect, contextFilterSelect, ipFilterSelect, analyzeButton,
                includeZeroActivitySwitch
            ];
            if (isLoading) {
                loadingIndicator.classList.remove('hidden');
                controls.forEach(control => control.disabled = true);
            } else {
                loadingIndicator.classList.add('hidden');
                controls.forEach(control => {
                    if (control.id === 'ipFilter') {
                        control.disabled = !ipColumnAvailable;
                    } else {
                        control.disabled = false;
                    }
                });
            }
        }

        function readFileAsText(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = event => resolve(event.target.result);
                reader.onerror = error => reject(error);
                reader.readAsText(file, 'UTF-8');
            });
        }

        function parseCSV(csvText) {
            const lines = csvText.trim().split(/\r?\n/);
            if (lines.length < 2) return [];
            const rawHeaderLine = lines[0].trim();
            const headerNames = parseCSVLine(rawHeaderLine); 
            const headerToStandardKeyMap = {};
            for (const key in CSV_COLUMN_MAPPING) {
                headerToStandardKeyMap[CSV_COLUMN_MAPPING[key]] = key;
            }
            const columnIndexToStandardKey = headerNames.map(name => headerToStandardKeyMap[name.trim()] || null);
            const data = [];
            for (let i = 1; i < lines.length; i++) {
                const lineContent = lines[i].trim();
                if (lineContent === '') continue;
                const values = parseCSVLine(lineContent);
                if (values.length !== headerNames.length) {
                    console.warn(`Discrepancia en número de columnas en línea ${i+1}. Esperado: ${headerNames.length}, Obtenido: ${values.length}. Línea: "${lines[i]}"`);
                    continue; 
                }
                const rowObject = {};
                let hasRequiredColumns = true;
                columnIndexToStandardKey.forEach((standardKey, index) => {
                    if (standardKey) rowObject[standardKey] = values[index];
                });
                if (!rowObject.TIME || !rowObject.FULL_NAME || !rowObject.COMPONENT || !rowObject.EVENT_NAME || !rowObject.EVENT_CONTEXT) {
                    hasRequiredColumns = false; 
                }
                if (hasRequiredColumns) data.push(rowObject);
            }
            return data;
        }

        function parseCSVLine(line) {
            const values = [];
            let inQuotes = false;
            let currentValue = '';
            for (let i = 0; i < line.length; i++) {
                const char = line[i];
                if (char === '"') {
                    if (inQuotes && i + 1 < line.length && line[i+1] === '"') {
                        currentValue += '"'; i++; 
                    } else {
                        inQuotes = !inQuotes;
                    }
                } else if (char === ',' && !inQuotes) {
                    values.push(currentValue); currentValue = '';
                } else {
                    currentValue += char;
                }
            }
            values.push(currentValue);
            return values.map(v => v.trim()); 
        }
        
        function parseMoodleDate(dateString) {
            if (!dateString || typeof dateString !== 'string') return null;
            const parts = dateString.split(',');
            if (parts.length !== 2) return null;
            const datePart = parts[0].trim(); 
            const timePart = parts[1].trim(); 
            const dateSegments = datePart.split('/');
            if (dateSegments.length !== 3) return null;
            let day = parseInt(dateSegments[0], 10);
            let month = parseInt(dateSegments[1], 10) - 1; 
            let yearSuffix = parseInt(dateSegments[2], 10);
            let year = (yearSuffix < 70) ? 2000 + yearSuffix : 1900 + yearSuffix;
            const timeSegments = timePart.split(':');
            if (timeSegments.length !== 3) return null;
            let hours = parseInt(timeSegments[0], 10);
            let minutes = parseInt(timeSegments[1], 10);
            let seconds = parseInt(timeSegments[2], 10);
            if (isNaN(day) || isNaN(month) || isNaN(year) || isNaN(hours) || isNaN(minutes) || isNaN(seconds) ||
                month < 0 || month > 11 || day < 1 || day > 31 || 
                hours < 0 || hours > 23 || minutes < 0 || minutes > 59 || seconds < 0 || seconds > 59) {
                return null;
            }
            const parsed = new Date(year, month, day, hours, minutes, seconds);
             if (isNaN(parsed.getTime())) return null;
            return parsed;
        }

        function populateFilterSelects(dataToGetOptionsFrom) { 
            const uniqueUserNames = [...new Set(dataToGetOptionsFrom.map(row => row.FULL_NAME || "Usuario Desconocido"))].sort();
            const uniqueEventNames = [...new Set(dataToGetOptionsFrom.map(row => row.EVENT_NAME || "Evento Desconocido"))].sort();
            const uniqueComponents = [...new Set(dataToGetOptionsFrom.map(row => row.COMPONENT || "Componente Desconocido"))].sort();
            const uniqueContexts = [...new Set(dataToGetOptionsFrom.map(row => row.EVENT_CONTEXT || "Contexto Desconocido"))].sort();

            const selectedUser = userFilterSelect.value;
            const selectedEvent = eventFilterSelect.value;
            const selectedComponent = componentFilterSelect.value; 
            const selectedContext = contextFilterSelect.value;
            const selectedIPs = Array.from(ipFilterSelect.selectedOptions).map(opt => opt.value);


            userFilterSelect.innerHTML = '<option value="ALL_USERS">Todos los Alumnos</option>';
            uniqueUserNames.forEach(name => {
                const option = document.createElement('option'); option.value = name; option.textContent = name;
                userFilterSelect.appendChild(option);
            });
            if (userFilterSelect.querySelector(`option[value="${selectedUser}"]`)) userFilterSelect.value = selectedUser;
            else userFilterSelect.value = "ALL_USERS";

            eventFilterSelect.innerHTML = '<option value="ALL_EVENTS">Todos los Eventos</option>';
            uniqueEventNames.forEach(name => {
                const option = document.createElement('option'); option.value = name; option.textContent = name;
                eventFilterSelect.appendChild(option);
            });
            if (eventFilterSelect.querySelector(`option[value="${selectedEvent}"]`)) eventFilterSelect.value = selectedEvent;
            else eventFilterSelect.value = "ALL_EVENTS";
            
            componentFilterSelect.innerHTML = '<option value="ALL_COMPONENTS">Todos los Componentes</option>';
            uniqueComponents.forEach(name => {
                const option = document.createElement('option'); option.value = name; option.textContent = name;
                componentFilterSelect.appendChild(option);
            });
            if (componentFilterSelect.querySelector(`option[value="${selectedComponent}"]`)) componentFilterSelect.value = selectedComponent;
            else componentFilterSelect.value = "ALL_COMPONENTS";


            contextFilterSelect.innerHTML = '<option value="ALL_CONTEXTS">Todos los Contextos</option>';
            uniqueContexts.forEach(name => {
                const option = document.createElement('option'); option.value = name; option.textContent = name;
                contextFilterSelect.appendChild(option);
            });
            if (contextFilterSelect.querySelector(`option[value="${selectedContext}"]`)) contextFilterSelect.value = selectedContext;
            else contextFilterSelect.value = "ALL_CONTEXTS";

            ipFilterSelect.innerHTML = ''; 
            if (ipColumnAvailable) {
                const uniqueIPs = [...new Set(dataToGetOptionsFrom.map(row => row.IP_ADDRESS || "IP Desconocida").filter(ip => ip !== "IP Desconocida"))].sort();
                uniqueIPs.forEach(ip => {
                    const option = document.createElement('option');
                    option.value = ip;
                    option.textContent = ip;
                    if(selectedIPs.includes(ip)) option.selected = true;
                    ipFilterSelect.appendChild(option);
                });
                ipFilterSelect.disabled = false;
                ipFilterHelpText.textContent = "Seleccione una o más IPs. Ninguna selección implica todas.";
            } else {
                ipFilterSelect.disabled = true;
                ipFilterHelpText.textContent = "Columna 'Dirección IP' no encontrada en el archivo.";
            }

            areFiltersPopulated = true;
        }
        
        function applyGlobalExclusions(sourceData) {
            let data = [...sourceData];

            if (excludedUserSubstrings.length > 0) {
                data = data.filter(row => {
                    const userNameLower = (row.FULL_NAME || "").toLowerCase();
                    return !excludedUserSubstrings.some(substring => userNameLower.includes(substring));
                });
            }
            if (excludedComponentSubstrings.length > 0) {
                data = data.filter(row => {
                    const componentNameLower = (row.COMPONENT || "").toLowerCase();
                    return !excludedComponentSubstrings.some(substring => componentNameLower.includes(substring));
                });
            }
            if (excludedEventNameSubstrings.length > 0) {
                data = data.filter(row => {
                    const eventNameLower = (row.EVENT_NAME || "").toLowerCase();
                    return !excludedEventNameSubstrings.some(substring => eventNameLower.includes(substring));
                });
            }
            if (excludedContextSubstrings.length > 0) {
                data = data.filter(row => {
                    const contextNameLower = (row.EVENT_CONTEXT || "").toLowerCase();
                    return !excludedContextSubstrings.some(substring => contextNameLower.includes(substring));
                });
            }
            return data;
        }

        function processAndDisplayData(sourceDataIgnored) { 
            if (!parsedDataCache || parsedDataCache.length === 0) {
                showUserMessage("No hay datos cargados para analizar.", "warning");
                resultsSection.classList.add('hidden');
                destroyAllDashboardCharts();
                clearDashboardStats();
                return;
            }
            
            let dataToProcessAfterGlobalExclusions = globallyProcessedDataForBaseLists;

            if (!areFiltersPopulated) { 
                populateFilterSelects(dataToProcessAfterGlobalExclusions); 
            }

            const startDateVal = startDateInput.valueAsDate;
            const endDateVal = endDateInput.valueAsDate;
            const startTimeString = startTimeFilter.value;
            const endTimeString = endTimeFilter.value;    
            const selectedUser = userFilterSelect.value;
            const selectedEvent = eventFilterSelect.value;
            const selectedComponent = componentFilterSelect.value; 
            const selectedContext = contextFilterSelect.value;
            const selectedIPs = Array.from(ipFilterSelect.selectedOptions).map(opt => opt.value);


            if (!startDateVal || !endDateVal) {
                showUserMessage("Fechas de inicio o fin inválidas.", "danger");
                resultsSection.classList.add('hidden');
                return;
            }
            
            const startDateObj = new Date(startDateVal.valueOf()); startDateObj.setHours(0,0,0,0);
            const endDateObj = new Date(endDateVal.valueOf()); endDateObj.setHours(23, 59, 59, 999); 

            if (startDateObj > endDateObj) {
                showUserMessage("La fecha de inicio no puede ser posterior a la fecha de fin.", "danger");
                resultsSection.classList.add('hidden');
                return;
            }

            let filterStartHour = 0, filterStartMinute = 0;
            let filterEndHour = 23, filterEndMinute = 59;

            if (startTimeString) {
                [filterStartHour, filterStartMinute] = startTimeString.split(':').map(Number);
            }
            if (endTimeString) {
                [filterEndHour, filterEndMinute] = endTimeString.split(':').map(Number);
            }
            
            const filterStartTimeInMinutes = filterStartHour * 60 + filterStartMinute;
            const filterEndTimeInMinutes = filterEndHour * 60 + filterEndMinute;

            filteredDataForCharts = dataToProcessAfterGlobalExclusions.filter(row => {
                const eventDate = parseMoodleDate(row.TIME);
                if (!eventDate) return false;

                const dateMatches = eventDate >= startDateObj && eventDate <= endDateObj;
                if (!dateMatches) return false;

                const eventHour = eventDate.getHours();
                const eventMinute = eventDate.getMinutes();
                const eventTimeInMinutes = eventHour * 60 + eventMinute;

                let timeMatches = false;
                if (filterStartTimeInMinutes <= filterEndTimeInMinutes) {
                    timeMatches = eventTimeInMinutes >= filterStartTimeInMinutes && eventTimeInMinutes <= filterEndTimeInMinutes;
                } else { 
                    timeMatches = eventTimeInMinutes >= filterStartTimeInMinutes || eventTimeInMinutes <= filterEndTimeInMinutes;
                }
                if (!timeMatches) return false;
                
                return true; 
            });
            
            if (selectedUser !== "ALL_USERS") filteredDataForCharts = filteredDataForCharts.filter(row => (row.FULL_NAME || "Usuario Desconocido") === selectedUser);
            if (selectedEvent !== "ALL_EVENTS") filteredDataForCharts = filteredDataForCharts.filter(row => (row.EVENT_NAME || "Evento Desconocido") === selectedEvent);
            if (selectedComponent !== "ALL_COMPONENTS") filteredDataForCharts = filteredDataForCharts.filter(row => (row.COMPONENT || "Componente Desconocido") === selectedComponent); 
            if (selectedContext !== "ALL_CONTEXTS") filteredDataForCharts = filteredDataForCharts.filter(row => (row.EVENT_CONTEXT || "Contexto Desconocido") === selectedContext);
            
            if (ipColumnAvailable && selectedIPs.length > 0) {
                filteredDataForCharts = filteredDataForCharts.filter(row => selectedIPs.includes(row.IP_ADDRESS || "IP Desconocida"));
            }

            if (filteredDataForCharts.length === 0 && !includeZeroActivity) {
                showUserMessage("No hay eventos que coincidan con los filtros y exclusiones aplicadas.", "warning");
                clearDashboardStats(); 
                dashDateRangeEl.textContent = `${startDateVal.toLocaleDateString()} - ${endDateVal.toLocaleDateString()}`;
                destroyAllDashboardCharts(); 
                renderAllDashboardCharts(); 
                logTableBody.innerHTML = '<tr><td colspan="6" class="text-center">No hay datos para mostrar.</td></tr>';
                tableRowCountEl.textContent = `Mostrando 0 filas.`;
                resultsSection.classList.remove('hidden'); 
                return;
            }

            const totalEvents = filteredDataForCharts.length;
            const userActivityAllFiltered = {}; 
            const uniqueEventDates = new Set();
            filteredDataForCharts.forEach(row => { 
                userActivityAllFiltered[row.FULL_NAME || "Usuario Desconocido"] = (userActivityAllFiltered[row.FULL_NAME || "Usuario Desconocido"] || 0) + 1;
                const eventDate = parseMoodleDate(row.TIME);
                if (eventDate) {
                    uniqueEventDates.add(eventDate.toISOString().split('T')[0]);
                }
            });
            const uniqueUsers = Object.keys(userActivityAllFiltered).length;
            const activeDaysCount = uniqueEventDates.size;
            const avgEventsPerDay = activeDaysCount > 0 ? (totalEvents / activeDaysCount).toFixed(2) : "0.00";
            
            const componentActivityAllFiltered = {};
            filteredDataForCharts.forEach(row => { componentActivityAllFiltered[row.COMPONENT || "Componente Desconocido"] = (componentActivityAllFiltered[row.COMPONENT || "Componente Desconocido"] || 0) + 1; });
            const eventNameActivityAllFiltered = {};
            filteredDataForCharts.forEach(row => { eventNameActivityAllFiltered[row.EVENT_NAME || "Nombre Evento Desconocido"] = (eventNameActivityAllFiltered[row.EVENT_NAME || "Nombre Evento Desconocido"] || 0) + 1; });
            
            const mostActiveUserData = Object.keys(userActivityAllFiltered).length > 0 ? Object.entries(userActivityAllFiltered).reduce((max, current) => current[1] > max[1] ? current : max, ["N/A", 0]) : ["N/A", 0];

            dashDateRangeEl.textContent = `${startDateVal.toLocaleDateString()} - ${endDateVal.toLocaleDateString()}`;
            dashTotalEventsEl.textContent = totalEvents;
            dashUniqueUsersEl.textContent = uniqueUsers;
            dashActiveDaysEl.textContent = activeDaysCount;
            dashAvgEventsPerDayEl.textContent = avgEventsPerDay;
            dashMostFrequentEventNameEl.textContent = getMostFrequent(eventNameActivityAllFiltered) || "N/A";
            dashMostFrequentComponentEl.textContent = getMostFrequent(componentActivityAllFiltered) || "N/A";
            dashMostActiveUserEl.textContent = mostActiveUserData[1] > 0 ? `${mostActiveUserData[0]} (${mostActiveUserData[1]} eventos)`: "N/A";

            renderAllDashboardCharts();
            renderLogTable(filteredDataForCharts);

            resultsSection.classList.remove('hidden');
            showUserMessage(`Análisis completado. Mostrando ${filteredDataForCharts.length} eventos.`, "success");
        }

        function getMostFrequent(activityObject) {
            if (Object.keys(activityObject).length === 0) return null;
            return Object.entries(activityObject).reduce((a, b) => a[1] > b[1] ? a : b)[0];
        }
        
        function calculateUserActivityData(dataForCounts, topN = 15, useZeroInclusionLogic = false, baseDataForEntityList = []) {
            const activity = {};

            if (useZeroInclusionLogic && baseDataForEntityList.length > 0) {
                const uniqueBaseUsers = [...new Set(baseDataForEntityList.map(row => row.FULL_NAME || "Usuario Desconocido"))];
                uniqueBaseUsers.forEach(user => activity[user] = 0);
            }

            dataForCounts.forEach(row => {
                const userName = row.FULL_NAME || "Usuario Desconocido";
                if (useZeroInclusionLogic && baseDataForEntityList.length > 0) {
                    if (activity.hasOwnProperty(userName)) {
                        activity[userName]++;
                    }
                } else {
                    activity[userName] = (activity[userName] || 0) + 1;
                }
            });

            let sortedArray = Object.entries(activity)
                .sort((a,b) => (b[1] - a[1]) || a[0].localeCompare(b[0])); 
            
            const finalSorted = (topN > 0 && sortedArray.length > topN) ? sortedArray.slice(0, topN) : sortedArray;
            return { labels: finalSorted.map(e => e[0]), dataValues: finalSorted.map(e => e[1]) };
        }

        function calculateComponentActivityData(dataForCounts, topN = 10, useZeroInclusionLogic = false, baseDataForEntityList = []) {
            const activity = {};

            if (useZeroInclusionLogic && baseDataForEntityList.length > 0) {
                const uniqueBaseComponents = [...new Set(baseDataForEntityList.map(row => row.COMPONENT || "Componente Desconocido"))];
                uniqueBaseComponents.forEach(component => activity[component] = 0);
            }

            dataForCounts.forEach(row => {
                const componentName = row.COMPONENT || "Componente Desconocido";
                if (useZeroInclusionLogic && baseDataForEntityList.length > 0) {
                    if (activity.hasOwnProperty(componentName)) {
                        activity[componentName]++;
                    }
                } else {
                    activity[componentName] = (activity[componentName] || 0) + 1;
                }
            });

            let sortedArray = Object.entries(activity)
                .sort((a,b) => (b[1] - a[1]) || a[0].localeCompare(b[0]));
            
            const finalSorted = (topN > 0 && sortedArray.length > topN) ? sortedArray.slice(0, topN) : sortedArray;
            return { labels: finalSorted.map(e => e[0]), dataValues: finalSorted.map(e => e[1]) };
        }


        function calculateEventsOverTimeData(data, filterStartDate, filterEndDate) {
            const eventsByDay = {};
            let currentDate = new Date(filterStartDate.valueOf());
            const endDateLoop = new Date(filterEndDate.valueOf());

            while(currentDate <= endDateLoop) {
                const dayKey = currentDate.toISOString().split('T')[0];
                eventsByDay[dayKey] = 0;
                currentDate.setDate(currentDate.getDate() + 1);
            }
            
            data.forEach(row => {
                const eventDate = parseMoodleDate(row.TIME);
                if (eventDate && eventDate >= filterStartDate && eventDate <= filterEndDate) {
                    const dayKey = eventDate.toISOString().split('T')[0];
                    if(eventsByDay.hasOwnProperty(dayKey)){
                       eventsByDay[dayKey]++;
                    }
                }
            });
            const sortedDays = Object.keys(eventsByDay).sort((a, b) => new Date(a) - new Date(b));
            return { labels: sortedDays, dataValues: sortedDays.map(day => eventsByDay[day]) };
        }

        function calculateActivityByHourData(data) {
            const hours = Array(24).fill(0);
            data.forEach(row => {
                const eventDate = parseMoodleDate(row.TIME);
                if (eventDate) hours[eventDate.getHours()]++;
            });
            return { 
                labels: hours.map((_, i) => `${String(i).padStart(2, '0')}:00`), 
                dataValues: hours 
            };
        }

        function calculateActivityByDayOfWeekData(data) {
            const days = Array(7).fill(0); 
            const dayNames = ["Lunes", "Martes", "Miércoles", "Jueves", "Viernes", "Sábado", "Domingo"];
            data.forEach(row => {
                const eventDate = parseMoodleDate(row.TIME);
                if (eventDate) {
                    const dayOfWeek = eventDate.getDay(); 
                    const adjustedIndex = dayOfWeek === 0 ? 6 : dayOfWeek - 1; 
                    days[adjustedIndex]++;
                }
            });
            return { labels: dayNames, dataValues: days };
        }
        
        function calculateActivityByContextData(dataForCounts, topN = 10, useBaseListForZeros = false, baseDataForEntityList = []) {
            const activity = {};

            if (useBaseListForZeros && baseDataForEntityList.length > 0) {
                const allPossibleContextsFromBase = [...new Set(baseDataForEntityList.map(row => row.EVENT_CONTEXT || "Contexto Desconocido"))];
                allPossibleContextsFromBase.forEach(ctx => activity[ctx] = 0);
                
                dataForCounts.forEach(row => {
                    const contextName = row.EVENT_CONTEXT || "Contexto Desconocido";
                    if (activity.hasOwnProperty(contextName)) { 
                        activity[contextName]++;
                    }
                });
            } else {
                dataForCounts.forEach(row => { 
                    const contextName = row.EVENT_CONTEXT || "Contexto Desconocido";
                    activity[contextName] = (activity[contextName] || 0) + 1;
                });
            }

            let sorted = Object.entries(activity).sort((a,b) => (b[1] - a[1]) || a[0].localeCompare(b[0]));
            
            if (topN > 0 && sorted.length > topN) {
                 sorted = sorted.slice(0, topN);
            }
            return { labels: sorted.map(e => e[0]), dataValues: sorted.map(e => e[1]) };
        }


        function calculateComponentBreakdownData(data, topNComponents = 3, topNEventsPerComponent = 3) {
            const componentActivity = {};
            data.forEach(row => {
                const component = row.COMPONENT || "Componente Desconocido";
                componentActivity[component] = (componentActivity[component] || 0) + 1;
            });
        
            const sortedComponents = Object.entries(componentActivity)
                .sort(([,a],[,b]) => b-a)
                .slice(0, topNComponents)
                .map(entry => entry[0]);
        
            const eventBreakdown = {}; 
            const allEventNames = new Set();
        
            sortedComponents.forEach(comp => {
                eventBreakdown[comp] = {};
                const componentEvents = data.filter(row => (row.COMPONENT || "Componente Desconocido") === comp);
                const eventCountsInComponent = {};
                componentEvents.forEach(row => {
                    const eventName = row.EVENT_NAME || "Evento Desconocido";
                    eventCountsInComponent[eventName] = (eventCountsInComponent[eventName] || 0) + 1;
                });
        
                Object.entries(eventCountsInComponent)
                    .sort(([,a],[,b]) => b-a)
                    .slice(0, topNEventsPerComponent)
                    .forEach(([eventName, count]) => {
                        eventBreakdown[comp][eventName] = count;
                        allEventNames.add(eventName);
                    });
            });
            
            const uniqueEventNamesArray = Array.from(allEventNames).sort();
            const datasets = uniqueEventNamesArray.map(eventName => {
                return {
                    label: eventName,
                    data: sortedComponents.map(comp => eventBreakdown[comp]?.[eventName] || 0),
                };
            });
        
            return { labels: sortedComponents, datasets: datasets };
        }

        function calculateScatterUsersEventsDayData(data) {
            const dailyActivity = {};
            data.forEach(row => {
                const eventDate = parseMoodleDate(row.TIME);
                if (!eventDate) return []; // Should be return; not return []
                const dayKey = eventDate.toISOString().split('T')[0];
                if (!dailyActivity[dayKey]) {
                    dailyActivity[dayKey] = { users: new Set(), eventCount: 0, date: eventDate };
                }
                dailyActivity[dayKey].users.add(row.FULL_NAME || "Usuario Desconocido");
                dailyActivity[dayKey].eventCount++;
            });

            return Object.entries(dailyActivity).map(([day, stats]) => ({
                x: stats.users.size,
                y: stats.eventCount,
                label: new Date(stats.date).toLocaleDateString('es-ES', { year: 'numeric', month: '2-digit', day: '2-digit' }) 
            })).sort((a,b) => new Date(a.label.split('/').reverse().join('-')) - new Date(b.label.split('/').reverse().join('-')));
        }

        function calculateScatterComponentsEventsUserData(data) {
            const userComponentActivity = {};
            data.forEach(row => {
                const userName = row.FULL_NAME || "Usuario Desconocido";
                const component = row.COMPONENT || "Componente Desconocido";
                if (!userComponentActivity[userName]) {
                    userComponentActivity[userName] = { components: new Set(), eventCount: 0 };
                }
                userComponentActivity[userName].components.add(component);
                userComponentActivity[userName].eventCount++;
            });
            return Object.entries(userComponentActivity).map(([user, stats]) => ({
                x: stats.components.size,
                y: stats.eventCount,
                label: user
            }));
        }

        function calculateScatterContentViewParticipationData(data) {
            const userInteractionProfile = {};
            const viewPatternsLower = VIEW_EVENT_PATTERNS.map(p => p.toLowerCase());
            const participationPatternsLower = PARTICIPATION_EVENT_PATTERNS.map(p => p.toLowerCase());

            data.forEach(row => {
                const userName = row.FULL_NAME || "Usuario Desconocido";
                const eventName = (row.EVENT_NAME || "").toLowerCase();
                if (!userInteractionProfile[userName]) {
                    userInteractionProfile[userName] = { viewEvents: 0, participationEvents: 0 };
                }

                let isViewEvent = viewPatternsLower.some(pattern => eventName.includes(pattern));
                let isParticipationEvent = participationPatternsLower.some(pattern => eventName.includes(pattern));

                if (isViewEvent) {
                    userInteractionProfile[userName].viewEvents++;
                }
                if (isParticipationEvent && !isViewEvent) { 
                    userInteractionProfile[userName].participationEvents++;
                }
            });
            return Object.entries(userInteractionProfile).map(([user, stats]) => ({
                x: stats.viewEvents,
                y: stats.participationEvents,
                label: user
            }));
        }
        
        function calculateBubbleStudentAnalysisData(data) {
            const studentProfiles = {};
            data.forEach(row => {
                const userName = row.FULL_NAME || "Usuario Desconocido";
                const eventDate = parseMoodleDate(row.TIME);
                if (!eventDate) return;
                const dayKey = eventDate.toISOString().split('T')[0];

                if (!studentProfiles[userName]) {
                    studentProfiles[userName] = { activeDays: new Set(), totalEvents: 0 };
                }
                studentProfiles[userName].activeDays.add(dayKey);
                studentProfiles[userName].totalEvents++;
            });

            return Object.entries(studentProfiles).map(([user, stats]) => {
                const numActiveDays = stats.activeDays.size;
                const avgEventsPerDay = numActiveDays > 0 ? (stats.totalEvents / numActiveDays) : 0;
                return {
                    x: numActiveDays,
                    y: parseFloat(avgEventsPerDay.toFixed(2)),
                    r: Math.max(5, stats.totalEvents / 10), 
                    _rawR: stats.totalEvents, 
                    label: user
                };
            });
        }

        function calculateBubbleComponentAnalysisData(data) {
            const componentProfiles = {};
            data.forEach(row => {
                const componentName = row.COMPONENT || "Componente Desconocido";
                const userName = row.FULL_NAME || "Usuario Desconocido";
                if (!componentProfiles[componentName]) {
                    componentProfiles[componentName] = { uniqueUsers: new Set(), totalEvents: 0 };
                }
                componentProfiles[componentName].uniqueUsers.add(userName);
                componentProfiles[componentName].totalEvents++;
            });
            return Object.entries(componentProfiles).map(([component, stats]) => {
                const numUniqueUsers = stats.uniqueUsers.size;
                const avgEventsPerUser = numUniqueUsers > 0 ? (stats.totalEvents / numUniqueUsers) : 0;
                return {
                    x: numUniqueUsers,
                    y: stats.totalEvents,
                    r: Math.max(5, parseFloat(avgEventsPerUser.toFixed(2))), 
                    _rawR: parseFloat(avgEventsPerUser.toFixed(2)),
                    label: component
                };
            });
        }

        function calculateBubbleContextAnalysisData(data) {
            const contextProfiles = {};
            data.forEach(row => {
                const contextName = row.EVENT_CONTEXT || "Contexto Desconocido";
                const userName = row.FULL_NAME || "Usuario Desconocido";
                if (!contextProfiles[contextName]) {
                    contextProfiles[contextName] = { activeStudents: new Set(), totalEvents: 0 };
                }
                contextProfiles[contextName].activeStudents.add(userName);
                contextProfiles[contextName].totalEvents++;
            });
            return Object.entries(contextProfiles).map(([context, stats]) => {
                const numActiveStudents = stats.activeStudents.size;
                const avgEventsPerStudent = numActiveStudents > 0 ? (stats.totalEvents / numActiveStudents) : 0;
                return {
                    x: numActiveStudents,
                    y: parseFloat(avgEventsPerStudent.toFixed(2)),
                    r: Math.max(5, stats.totalEvents / 20), 
                    _rawR: stats.totalEvents,
                    label: context
                };
            });
        }

        function calculateTopIPsByEventsData(dataForCounts, topN = 10, useZeroInclusionLogic = false, baseDataForEntityList = []) {
            if (!ipColumnAvailable) return { labels: [], dataValues: [] };
            const ipActivity = {};

            if (useZeroInclusionLogic && baseDataForEntityList.length > 0) {
                const uniqueBaseIPs = [...new Set(baseDataForEntityList.map(row => row.IP_ADDRESS).filter(ip => ip && ip !== "IP Desconocida"))];
                uniqueBaseIPs.forEach(ip => ipActivity[ip] = 0);
            }

            dataForCounts.forEach(row => {
                const ip = row.IP_ADDRESS || "IP Desconocida";
                if (ip === "IP Desconocida") return;

                if (useZeroInclusionLogic && baseDataForEntityList.length > 0) {
                    if (ipActivity.hasOwnProperty(ip)) {
                        ipActivity[ip]++;
                    }
                } else {
                    ipActivity[ip] = (ipActivity[ip] || 0) + 1;
                }
            });

            let sortedArray = Object.entries(ipActivity)
                .sort((a,b) => (b[1] - a[1]) || a[0].localeCompare(b[0]));
            
            const finalSorted = (topN > 0 && sortedArray.length > topN) ? sortedArray.slice(0, topN) : sortedArray;
            return { labels: finalSorted.map(e => e[0]), dataValues: finalSorted.map(e => e[1]) };
        }

        function calculateUsersPerIPData(dataForCounts, topN = 10, useZeroInclusionLogic = false, baseDataForEntityList = []) {
            if (!ipColumnAvailable) return { labels: [], dataValues: [] };
            const ipUserSets = {};

            if (useZeroInclusionLogic && baseDataForEntityList.length > 0) {
                const uniqueBaseIPs = [...new Set(baseDataForEntityList.map(row => row.IP_ADDRESS).filter(ip => ip && ip !== "IP Desconocida"))];
                uniqueBaseIPs.forEach(ip => ipUserSets[ip] = new Set());
            }

            dataForCounts.forEach(row => {
                const ip = row.IP_ADDRESS || "IP Desconocida";
                const user = row.FULL_NAME || "Usuario Desconocido";
                if (ip === "IP Desconocida") return;

                if (useZeroInclusionLogic && baseDataForEntityList.length > 0) {
                    if (ipUserSets.hasOwnProperty(ip)) {
                        ipUserSets[ip].add(user);
                    }
                } else {
                    if (!ipUserSets[ip]) {
                        ipUserSets[ip] = new Set();
                    }
                    ipUserSets[ip].add(user);
                }
            });

            const ipUserCounts = Object.entries(ipUserSets).map(([ip, usersSet]) => [ip, usersSet.size]);
            let sortedArray = ipUserCounts.sort((a,b) => (b[1] - a[1]) || a[0].localeCompare(b[0]));
            
            const finalSorted = (topN > 0 && sortedArray.length > topN) ? sortedArray.slice(0, topN) : sortedArray;
            return { labels: finalSorted.map(e => e[0]), dataValues: finalSorted.map(e => e[1]) };
        }

        function calculateIPsPerUserData(dataForCounts, topN = 10, useZeroInclusionLogic = false, baseDataForEntityList = []) {
            if (!ipColumnAvailable) return { labels: [], dataValues: [] };
            const userIPSets = {};

            if (useZeroInclusionLogic && baseDataForEntityList.length > 0) {
                const uniqueBaseUsers = [...new Set(baseDataForEntityList.map(row => row.FULL_NAME || "Usuario Desconocido"))];
                uniqueBaseUsers.forEach(user => userIPSets[user] = new Set());
            }

            dataForCounts.forEach(row => {
                const user = row.FULL_NAME || "Usuario Desconocido";
                const ip = row.IP_ADDRESS || "IP Desconocida";
                if (ip === "IP Desconocida") return; 

                if (useZeroInclusionLogic && baseDataForEntityList.length > 0) {
                    if (userIPSets.hasOwnProperty(user)) {
                        userIPSets[user].add(ip);
                    }
                } else {
                    if (!userIPSets[user]) {
                        userIPSets[user] = new Set();
                    }
                    userIPSets[user].add(ip);
                }
            });
            
            const userIPCounts = Object.entries(userIPSets).map(([user, ipSet]) => [user, ipSet.size]);
            let sortedArray = userIPCounts.sort((a,b) => (b[1] - a[1]) || a[0].localeCompare(b[0]));

            const finalSorted = (topN > 0 && sortedArray.length > topN) ? sortedArray.slice(0, topN) : sortedArray;
            return { labels: finalSorted.map(e => e[0]), dataValues: finalSorted.map(e => e[1]) };
        }


        const CHART_COLORS = [
            'rgba(255, 99, 132, 0.7)', 'rgba(54, 162, 235, 0.7)', 'rgba(255, 206, 86, 0.7)',
            'rgba(75, 192, 192, 0.7)', 'rgba(153, 102, 255, 0.7)', 'rgba(255, 159, 64, 0.7)',
            'rgba(199, 199, 199, 0.7)', 'rgba(83, 102, 255, 0.7)', 'rgba(40, 159, 64, 0.7)',
            'rgba(255, 130, 50, 0.7)', 'rgba(100, 100, 255, 0.7)', 'rgba(60, 200, 100, 0.7)'
        ];
        function getChartColors(count) {
            const colors = [];
            for (let i = 0; i < count; i++) {
                colors.push(CHART_COLORS[i % CHART_COLORS.length]);
            }
            return colors;
        }

        function renderAllDashboardCharts() {
            renderDashUserActivityChart();
            renderDashEventsOverTimeChart();
            renderDashComponentActivityChart();
            renderDashActivityByHourChart();
            renderDashActivityByDayOfWeekChart();
            renderDashComponentBreakdownChart();
            renderDashActivityByContextChart();
            renderDashScatterUsersEventsDayChart();
            renderDashScatterComponentsEventsUserChart();
            renderDashScatterContentViewParticipationChart();
            renderDashBubbleStudentAnalysisChart();
            renderDashBubbleComponentAnalysisChart();
            renderDashBubbleContextAnalysisChart();
            renderDashTopIPsByEventsChart();
            renderDashUsersPerIPChart();
            renderDashIPsPerUserChart();
        }

        function renderGenericChart(canvasId, existingChartInstance, chartConfig, noDataMessage = "No hay datos para mostrar.", ipSpecificMessage = "Columna 'Dirección IP' no encontrada.") {
            if (existingChartInstance) {
                existingChartInstance.destroy();
            }
            const canvas = document.getElementById(canvasId);
            if (!canvas) { console.error(`Canvas con ID ${canvasId} no encontrado.`); return null; }
            const ctx = canvas.getContext('2d');
            ctx.clearRect(0, 0, canvas.width, canvas.height); 

            const isIPChart = ['dashTopIPsByEventsChart', 'dashUsersPerIPChart', 'dashIPsPerUserChart', 
                               'topIPsByEventsModalCanvas', 'usersPerIPModalCanvas', 'ipsPerUserModalCanvas'].includes(canvasId);
            if (isIPChart && !ipColumnAvailable) {
                ctx.save();
                ctx.textAlign = 'center';
                ctx.textBaseline = 'middle';
                ctx.font = "14px " + Chart.defaults.font.family;
                ctx.fillStyle = "#6c757d"; 
                ctx.fillText(ipSpecificMessage, canvas.width / 2, canvas.height / 2);
                ctx.restore();
                return null;
            }

            const isScatterOrBubble = chartConfig.type === 'scatter' || chartConfig.type === 'bubble';
            let hasData = false;
            if (isScatterOrBubble) {
                hasData = chartConfig.data.datasets && chartConfig.data.datasets.some(ds => ds.data && ds.data.length > 0);
            } else {
                const hasLabels = chartConfig.data.labels && chartConfig.data.labels.length > 0;
                const hasDataInDatasets = chartConfig.data.datasets && chartConfig.data.datasets.some(ds => ds.data && ds.data.length > 0);
                const allDatasetValuesAreZero = chartConfig.data.datasets && chartConfig.data.datasets.every(ds => ds.data.every(val => val === 0));
                
                const isAffectedRankingChart = [
                    'dashUserActivityChart', 'dashComponentActivityChart', 'dashActivityByContextChart',
                    'dashTopIPsByEventsChart', 'dashUsersPerIPChart', 'dashIPsPerUserChart',
                    'activityByUserChart', 'activityByComponentChart', 'activityByContextChartModal',
                    'topIPsByEventsModalCanvas', 'usersPerIPModalCanvas', 'ipsPerUserModalCanvas'
                ].includes(canvasId);

                if (isAffectedRankingChart && includeZeroActivity && hasLabels) {
                    hasData = true;
                } else if (hasLabels && hasDataInDatasets) {
                    if ((chartConfig.type === 'doughnut' || chartConfig.type === 'pie') && allDatasetValuesAreZero && !(isAffectedRankingChart && includeZeroActivity)) {
                        hasData = false;
                    } else {
                        hasData = true;
                    }
                }
            }
            
            if (!hasData) {
                ctx.save();
                ctx.textAlign = 'center';
                ctx.textBaseline = 'middle';
                ctx.font = "14px " + Chart.defaults.font.family;
                ctx.fillStyle = "#6c757d"; 
                ctx.fillText(noDataMessage, canvas.width / 2, canvas.height / 2);
                ctx.restore();
                return null; 
            }
            
            return new Chart(ctx, chartConfig);
        }

        function renderDashUserActivityChart() {
            const topNDashboard = 15;
            const { labels, dataValues } = calculateUserActivityData(
                filteredDataForCharts, 
                topNDashboard,
                includeZeroActivity,
                includeZeroActivity ? globallyProcessedDataForBaseLists : []
            );
            const chartConfig = {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: `Top ${labels.length} Alumnos`, data: dataValues,
                        backgroundColor: getChartColors(labels.length),
                        borderColor: getChartColors(labels.length).map(c => c.replace('0.7', '1')),
                        borderWidth: 1
                    }]
                },
                options: { indexAxis: 'y', responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { y: { ticks: { autoSkip: false, font: {size: 9} } }, x: { ticks: { font: {size: 9} } } } }
            };
            dashUserActivityChartInstance = renderGenericChart('dashUserActivityChart', dashUserActivityChartInstance, chartConfig);
        }

        function renderDashEventsOverTimeChart() {
            const sDate = startDateInput.valueAsDate ? new Date(startDateInput.valueAsDate.valueOf()) : new Date();
            const eDate = endDateInput.valueAsDate ? new Date(endDateInput.valueAsDate.valueOf()) : new Date();
            sDate.setHours(0,0,0,0);
            eDate.setHours(23,59,59,999);

            const { labels, dataValues } = calculateEventsOverTimeData(filteredDataForCharts, sDate, eDate);
            const chartConfig = {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Eventos por Día', data: dataValues,
                        borderColor: 'rgb(75, 192, 192)', tension: 0.1, fill: false, borderWidth: 2
                    }]
                },
                options: { responsive: true, maintainAspectRatio: false, scales: { x: { type: 'time', time: { unit: 'day', tooltipFormat: 'dd/MM/yyyy', displayFormats: {day: 'dd/MM'}}, ticks:{font:{size:9}}}, y: {beginAtZero: true, ticks:{font:{size:9}}} }, plugins: { legend: { display: false } } }
            };
            dashEventsOverTimeChartInstance = renderGenericChart('dashEventsOverTimeChart', dashEventsOverTimeChartInstance, chartConfig);
        }
        
        function renderDashComponentActivityChart() {
            const topNDashboard = 10;
            const { labels, dataValues } = calculateComponentActivityData(
                filteredDataForCharts, 
                topNDashboard,
                includeZeroActivity,
                includeZeroActivity ? globallyProcessedDataForBaseLists : []
            );
            const chartConfig = {
                type: 'doughnut',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Componentes', data: dataValues,
                        backgroundColor: getChartColors(labels.length),
                        borderColor: getChartColors(labels.length).map(c => c.replace('0.7', '1')),
                        borderWidth: 1
                    }]
                },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: labels.length > 0 && labels.length <= 6, labels:{font:{size:9}} } } }
            };
             dashComponentActivityChartInstance = renderGenericChart('dashComponentActivityChart', dashComponentActivityChartInstance, chartConfig);
        }
        
        function renderDashActivityByHourChart() {
            const { labels, dataValues } = calculateActivityByHourData(filteredDataForCharts);
            const chartConfig = {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Eventos por Hora', data: dataValues,
                        backgroundColor: CHART_COLORS[1], borderColor: CHART_COLORS[1].replace('0.7', '1'), borderWidth: 1
                    }]
                },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: {x: {ticks: {autoSkip: true, maxTicksLimit:12, font:{size:9}}}, y:{ticks:{font:{size:9}}}} }
            };
            dashActivityByHourChartInstance = renderGenericChart('dashActivityByHourChart', dashActivityByHourChartInstance, chartConfig);
        }

        function renderDashActivityByDayOfWeekChart() {
            const { labels, dataValues } = calculateActivityByDayOfWeekData(filteredDataForCharts);
            const chartConfig = {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Eventos por Día Semana', data: dataValues,
                        backgroundColor: CHART_COLORS[3], borderColor: CHART_COLORS[3].replace('0.7', '1'), borderWidth: 1
                    }]
                },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales:{x:{ticks:{font:{size:9}}}, y:{ticks:{font:{size:9}}}} }
            };
            dashActivityByDayOfWeekChartInstance = renderGenericChart('dashActivityByDayOfWeekChart', dashActivityByDayOfWeekChartInstance, chartConfig);
        }

        function renderDashComponentBreakdownChart() {
            const topNCompDash = 3, topNEventsDash = 3;
            const { labels, datasets } = calculateComponentBreakdownData(filteredDataForCharts, topNCompDash, topNEventsDash);
            
            datasets.forEach((ds, index) => {
                ds.backgroundColor = CHART_COLORS[index % CHART_COLORS.length];
                ds.borderColor = CHART_COLORS[index % CHART_COLORS.length].replace('0.7','1');
                ds.borderWidth = 1;
            });

            const chartConfig = {
                type: 'bar',
                data: { labels: labels, datasets: datasets },
                options: {
                    responsive: true, maintainAspectRatio: false,
                    plugins: { legend: { display: datasets.length > 0 && datasets.length <= 5, labels:{font:{size:9}} } }, 
                    scales: { x: { stacked: false, ticks:{font:{size:9}} }, y: { stacked: false, beginAtZero: true, ticks:{font:{size:9}} } } 
                }
            };
             dashComponentBreakdownChartInstance = renderGenericChart('dashComponentBreakdownChart', dashComponentBreakdownChartInstance, chartConfig, "Pocos datos para desglose");
        }
        
        function renderDashActivityByContextChart() {
            const topNDashboard = 10;
            const { labels, dataValues } = calculateActivityByContextData(
                filteredDataForCharts, 
                topNDashboard, 
                includeZeroActivity, 
                includeZeroActivity ? globallyProcessedDataForBaseLists : []
            ); 
            const chartConfig = {
                type: 'bar', 
                data: {
                    labels: labels,
                    datasets: [{
                        label: `Top ${labels.length} Contextos`, data: dataValues,
                        backgroundColor: getChartColors(labels.length),
                        borderColor: getChartColors(labels.length).map(c => c.replace('0.7', '1')),
                        borderWidth: 1
                    }]
                },
                options: { indexAxis: 'y', responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { y: { ticks: { autoSkip: false, font:{size:9} } }, x:{ticks:{font:{size:9}}} } }
            };
            dashActivityByContextChartInstance = renderGenericChart('dashActivityByContextChart', dashActivityByContextChartInstance, chartConfig);
        }

        function renderDashScatterUsersEventsDayChart() {
            const scatterData = calculateScatterUsersEventsDayData(filteredDataForCharts);
            const chartConfig = {
                type: 'scatter',
                data: {
                    datasets: [{
                        label: 'Días',
                        data: scatterData,
                        backgroundColor: CHART_COLORS[4]
                    }]
                },
                options: {
                    responsive: true, maintainAspectRatio: false,
                    plugins: { legend: { display: false }, tooltip: scatterTooltipCallbacks('Usuarios Únicos', 'Total Eventos') },
                    scales: {
                        x: { title: { display: true, text: 'Usuarios Únicos', font:{size:9} }, ticks:{font:{size:8}} },
                        y: { title: { display: true, text: 'Total Eventos', font:{size:9} }, ticks:{font:{size:8}} }
                    }
                }
            };
            dashScatterUsersEventsDayInstance = renderGenericChart('dashScatterUsersEventsDayChart', dashScatterUsersEventsDayInstance, chartConfig);
        }

        function renderDashScatterComponentsEventsUserChart() {
            const scatterData = calculateScatterComponentsEventsUserData(filteredDataForCharts);
            const chartConfig = {
                type: 'scatter',
                data: {
                    datasets: [{
                        label: 'Alumnos',
                        data: scatterData,
                        backgroundColor: CHART_COLORS[5]
                    }]
                },
                options: {
                    responsive: true, maintainAspectRatio: false,
                    plugins: { legend: { display: false }, tooltip: scatterTooltipCallbacks('Componentes Únicos', 'Total Eventos') },
                    scales: {
                        x: { title: { display: true, text: 'Componentes Únicos', font:{size:9} }, ticks:{font:{size:8}} },
                        y: { title: { display: true, text: 'Total Eventos', font:{size:9} }, ticks:{font:{size:8}} }
                    }
                }
            };
            dashScatterComponentsEventsUserInstance = renderGenericChart('dashScatterComponentsEventsUserChart', dashScatterComponentsEventsUserInstance, chartConfig);
        }
        
        function renderDashScatterContentViewParticipationChart() {
            const scatterData = calculateScatterContentViewParticipationData(filteredDataForCharts);
            const chartConfig = {
                type: 'scatter',
                data: {
                    datasets: [{
                        label: 'Alumnos',
                        data: scatterData,
                        backgroundColor: CHART_COLORS[6]
                    }]
                },
                options: {
                    responsive: true, maintainAspectRatio: false,
                    plugins: { legend: { display: false }, tooltip: scatterTooltipCallbacks('Evts. Visualización', 'Evts. Participación') },
                    scales: {
                        x: { title: { display: true, text: 'Evts. Visualización', font:{size:9} }, ticks:{font:{size:8}} },
                        y: { title: { display: true, text: 'Evts. Participación', font:{size:9} }, ticks:{font:{size:8}} }
                    }
                }
            };
            dashScatterContentViewParticipationInstance = renderGenericChart('dashScatterContentViewParticipationChart', dashScatterContentViewParticipationInstance, chartConfig);
        }

        function renderDashBubbleStudentAnalysisChart() {
            const bubbleData = calculateBubbleStudentAnalysisData(filteredDataForCharts);
            const chartConfig = {
                type: 'bubble',
                data: {
                    datasets: [{
                        label: 'Alumnos',
                        data: bubbleData,
                        backgroundColor: CHART_COLORS[0]
                    }]
                },
                options: {
                    responsive: true, maintainAspectRatio: false,
                    plugins: { legend: { display: false }, tooltip: bubbleTooltipCallbacks('Días Act.', 'Ø Evt/Día', 'Total Evt.') },
                    scales: {
                        x: { title: { display: true, text: 'Días Activos', font:{size:9} }, ticks:{font:{size:8}} },
                        y: { title: { display: true, text: 'Prom. Eventos/Día', font:{size:9} }, ticks:{font:{size:8}} }
                    }
                }
            };
            dashBubbleStudentAnalysisInstance = renderGenericChart('dashBubbleStudentAnalysisChart', dashBubbleStudentAnalysisInstance, chartConfig);
        }
        
        function renderDashBubbleComponentAnalysisChart() {
            const bubbleData = calculateBubbleComponentAnalysisData(filteredDataForCharts);
            const chartConfig = {
                type: 'bubble',
                data: {
                    datasets: [{
                        label: 'Componentes',
                        data: bubbleData,
                        backgroundColor: CHART_COLORS[1]
                    }]
                },
                options: {
                    responsive: true, maintainAspectRatio: false,
                    plugins: { legend: { display: false }, tooltip: bubbleTooltipCallbacks('Usr. Únicos', 'Total Evt.', 'Ø Evt/Usr') },
                    scales: {
                        x: { title: { display: true, text: 'Usuarios Únicos', font:{size:9} }, ticks:{font:{size:8}} },
                        y: { title: { display: true, text: 'Total Eventos', font:{size:9} }, ticks:{font:{size:8}} }
                    }
                }
            };
            dashBubbleComponentAnalysisInstance = renderGenericChart('dashBubbleComponentAnalysisChart', dashBubbleComponentAnalysisInstance, chartConfig);
        }

        function renderDashBubbleContextAnalysisChart() {
            const bubbleData = calculateBubbleContextAnalysisData(filteredDataForCharts);
            const chartConfig = {
                type: 'bubble',
                data: {
                    datasets: [{
                        label: 'Contextos',
                        data: bubbleData,
                        backgroundColor: CHART_COLORS[2]
                    }]
                },
                options: {
                    responsive: true, maintainAspectRatio: false,
                    plugins: { legend: { display: false }, tooltip: bubbleTooltipCallbacks('Alu. Activos', 'Ø Evt/Alu.', 'Total Evt.') },
                    scales: {
                        x: { title: { display: true, text: 'Alumnos Activos', font:{size:9} }, ticks:{font:{size:8}} },
                        y: { title: { display: true, text: 'Prom. Eventos/Alumno', font:{size:9} }, ticks:{font:{size:8}} }
                    }
                }
            };
            dashBubbleContextAnalysisInstance = renderGenericChart('dashBubbleContextAnalysisChart', dashBubbleContextAnalysisInstance, chartConfig);
        }
        
        function renderDashTopIPsByEventsChart() {
            const topN = 10;
            const { labels, dataValues } = calculateTopIPsByEventsData(
                filteredDataForCharts, 
                topN,
                includeZeroActivity,
                includeZeroActivity ? globallyProcessedDataForBaseLists : []
            );
            const chartConfig = {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: `Top ${labels.length} IPs por Eventos`, data: dataValues,
                        backgroundColor: getChartColors(labels.length),
                        borderWidth: 1
                    }]
                },
                options: { indexAxis: 'y', responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { y: { ticks: { autoSkip: false, font: {size: 9} } }, x: { ticks: { font: {size: 9} } } } }
            };
            dashTopIPsByEventsInstance = renderGenericChart('dashTopIPsByEventsChart', dashTopIPsByEventsInstance, chartConfig);
        }

        function renderDashUsersPerIPChart() {
            const topN = 10;
            const { labels, dataValues } = calculateUsersPerIPData(
                filteredDataForCharts, 
                topN,
                includeZeroActivity,
                includeZeroActivity ? globallyProcessedDataForBaseLists : []
            );
            const chartConfig = {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: `Top ${labels.length} IPs por Alumnos`, data: dataValues,
                        backgroundColor: getChartColors(labels.length),
                        borderWidth: 1
                    }]
                },
                options: { indexAxis: 'y', responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { y: { ticks: { autoSkip: false, font: {size: 9} } }, x: { ticks: { font: {size: 9} } } } }
            };
            dashUsersPerIPInstance = renderGenericChart('dashUsersPerIPChart', dashUsersPerIPInstance, chartConfig);
        }

        function renderDashIPsPerUserChart() {
            const topN = 10;
            const { labels, dataValues } = calculateIPsPerUserData(
                filteredDataForCharts, 
                topN,
                includeZeroActivity,
                includeZeroActivity ? globallyProcessedDataForBaseLists : []
            );
            const chartConfig = {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: `Top ${labels.length} Alumnos por IPs`, data: dataValues,
                        backgroundColor: getChartColors(labels.length),
                        borderWidth: 1
                    }]
                },
                options: { indexAxis: 'y', responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { y: { ticks: { autoSkip: false, font: {size: 9} } }, x: { ticks: { font: {size: 9} } } } }
            };
            dashIPsPerUserInstance = renderGenericChart('dashIPsPerUserChart', dashIPsPerUserInstance, chartConfig);
        }

        function scatterTooltipCallbacks(xLabel = 'X', yLabel = 'Y') {
            return {
                callbacks: {
                    label: function(context) {
                        const point = context.raw;
                        let tooltipLabel = point.label || `Punto (${point.x}, ${point.y})`;
                        return `${tooltipLabel}: (${xLabel}: ${point.x}, ${yLabel}: ${point.y})`;
                    }
                }
            };
        }

        function bubbleTooltipCallbacks(xLabel = 'X', yLabel = 'Y', rLabel = 'R') {
             return {
                callbacks: {
                    label: function(context) {
                        const point = context.raw;
                        let tooltipLabel = point.label || `Burbuja (${point.x}, ${point.y})`;
                        const rValue = point._rawR !== undefined ? point._rawR : point.r;
                        return `${tooltipLabel}: (${xLabel}: ${point.x}, ${yLabel}: ${point.y}, ${rLabel}: ${rValue})`;
                    }
                }
            };
        }

        function renderChartInModal(type, canvasIdForModal) {
            if (modalChartInstance) {
                modalChartInstance.destroy();
                modalChartInstance = null;
            }
            
            const canvas = document.getElementById(canvasIdForModal);
            if (!canvas) { console.error("Canvas para modal no encontrado:", canvasIdForModal); return; }
            const ctx = canvas.getContext('2d');
            ctx.clearRect(0, 0, canvas.width, canvas.height); 

            let chartConfigType, chartOptions = { responsive: true, maintainAspectRatio: false };
            let datasets = [];
            let labels = []; 

            const topNModalDefault = 0; 
            const topNCompModal = 10, topNEventsModal = 10; 

            const isIPModalChart = ['topIPsByEvents', 'usersPerIP', 'ipsPerUser'].includes(type);
            if (isIPModalChart && !ipColumnAvailable) {
                ctx.save();
                ctx.textAlign = 'center';
                ctx.textBaseline = 'middle';
                ctx.font = "16px " + Chart.defaults.font.family;
                ctx.fillStyle = "#6c757d";
                ctx.fillText("Columna 'Dirección IP' no encontrada. Este gráfico no puede mostrarse.", canvas.width / 2, canvas.height / 2);
                ctx.restore();
                return;
            }
            
            const isRankingChartType = ['userActivity', 'componentActivity', 'activityByContext', 'topIPsByEvents', 'usersPerIP', 'ipsPerUser'].includes(type);
            if (filteredDataForCharts.length === 0 && !(isRankingChartType && includeZeroActivity)) {
                ctx.save();
                ctx.textAlign = 'center';
                ctx.textBaseline = 'middle';
                ctx.font = "16px " + Chart.defaults.font.family;
                ctx.fillStyle = "#6c757d";
                ctx.fillText("No hay datos filtrados para mostrar en detalle.", canvas.width / 2, canvas.height / 2);
                ctx.restore();
                return;
            }
            
            let titleForChart = "";
            const sDateModal = startDateInput.valueAsDate ? new Date(startDateInput.valueAsDate.valueOf()) : new Date();
            const eDateModal = endDateInput.valueAsDate ? new Date(endDateInput.valueAsDate.valueOf()) : new Date();
            sDateModal.setHours(0,0,0,0);
            eDateModal.setHours(23,59,59,999);
            
            let calculatedData; 

            switch (type) {
                case 'userActivity':
                    const uActivity = calculateUserActivityData(
                        filteredDataForCharts, 
                        topNModalDefault,
                        includeZeroActivity,
                        includeZeroActivity ? globallyProcessedDataForBaseLists : []
                    );
                    labels = uActivity.labels;
                    datasets = [{ label: 'Eventos por Alumno', data: uActivity.dataValues, backgroundColor: CHART_COLORS[0] }];
                    chartConfigType = 'bar';
                    chartOptions.indexAxis = 'y';
                    chartOptions.scales = { y: { ticks: { autoSkip: false } } };
                    titleForChart = `Actividad por Alumno (Total: ${labels.length})`;
                    break;
                case 'eventsOverTime':
                    const eTime = calculateEventsOverTimeData(filteredDataForCharts, sDateModal, eDateModal);
                    labels = eTime.labels;
                    datasets = [{ label: 'Eventos por Día', data: eTime.dataValues, borderColor: CHART_COLORS[1], fill: false, tension: 0.1, borderWidth: 2 }];
                    chartConfigType = 'line';
                    chartOptions.scales = { x: { type: 'time', time: { unit: 'day', tooltipFormat: 'PPPp', displayFormats: { day: 'dd/MM/yy' }}}, y: {beginAtZero: true} };
                    titleForChart = 'Eventos por Día';
                    break;
                case 'componentActivity':
                    const cActivity = calculateComponentActivityData(
                        filteredDataForCharts, 
                        topNModalDefault,
                        includeZeroActivity,
                        includeZeroActivity ? globallyProcessedDataForBaseLists : []
                    );
                    labels = cActivity.labels;
                    datasets = [{ label: 'Eventos por Componente', data: cActivity.dataValues, backgroundColor: getChartColors(labels.length) }];
                    chartConfigType = 'doughnut';
                    titleForChart = `Actividad por Componente (Total: ${labels.length})`;
                    break;
                case 'activityByHour':
                    const byHour = calculateActivityByHourData(filteredDataForCharts);
                    labels = byHour.labels;
                    datasets = [{ label: 'Eventos por Hora', data: byHour.dataValues, backgroundColor: CHART_COLORS[2] }];
                    chartConfigType = 'bar';
                    titleForChart = 'Eventos por Hora del Día';
                    break;
                case 'activityByDayOfWeek':
                    const byDay = calculateActivityByDayOfWeekData(filteredDataForCharts);
                    labels = byDay.labels;
                    datasets = [{ label: 'Eventos por Día de Semana', data: byDay.dataValues, backgroundColor: CHART_COLORS[3] }];
                    chartConfigType = 'bar';
                    titleForChart = 'Eventos por Día de la Semana';
                    break;
                case 'componentBreakdown':
                    const breakdown = calculateComponentBreakdownData(filteredDataForCharts, topNCompModal, topNEventsModal);
                    labels = breakdown.labels;
                    datasets = breakdown.datasets;
                    datasets.forEach((ds, index) => { ds.backgroundColor = CHART_COLORS[index % CHART_COLORS.length]; });
                    chartConfigType = 'bar';
                    chartOptions.scales = { x: { stacked: false }, y: { stacked: false, beginAtZero: true } };
                    titleForChart = `Desglose de Eventos (Top ${topNEventsModal}) en Componentes Principales (Top ${topNCompModal})`;
                    break;
                case 'activityByContext':
                    const byContext = calculateActivityByContextData(
                        filteredDataForCharts,      
                        0,                          
                        includeZeroActivity,        
                        includeZeroActivity ? globallyProcessedDataForBaseLists : [] 
                    );                                                                
                                        
                    labels = byContext.labels;
                    datasets = [{ label: 'Eventos por Contexto', data: byContext.dataValues, backgroundColor: getChartColors(labels.length) }];
                    chartConfigType = 'bar';
                    chartOptions.indexAxis = 'y';
                    chartOptions.scales = { y: { ticks: { autoSkip: false } } };
                    titleForChart = includeZeroActivity ? 
                                    `Actividad por Contexto (Todos base, Total: ${labels.length})` :
                                    `Actividad por Contexto (Con actividad, Total: ${labels.length})`;
                    break;
                case 'scatterUsersEventsDay':
                    calculatedData = calculateScatterUsersEventsDayData(filteredDataForCharts);
                    datasets = [{ label: 'Días', data: calculatedData, backgroundColor: CHART_COLORS[4] }];
                    chartConfigType = 'scatter';
                    chartOptions.scales = { x: { title: { display: true, text: 'Usuarios Únicos' } }, y: { title: { display: true, text: 'Total Eventos' } } };
                    chartOptions.plugins = { tooltip: scatterTooltipCallbacks('Usr. Únicos', 'Total Evt.') };
                    titleForChart = 'Dispersión: Usuarios Únicos vs Eventos Totales (por Día)';
                    break;
                case 'scatterComponentsEventsUser':
                    calculatedData = calculateScatterComponentsEventsUserData(filteredDataForCharts);
                    datasets = [{ label: 'Alumnos', data: calculatedData, backgroundColor: CHART_COLORS[5] }];
                    chartConfigType = 'scatter';
                    chartOptions.scales = { x: { title: { display: true, text: 'Componentes Únicos Accedidos' } }, y: { title: { display: true, text: 'Total Eventos' } } };
                    chartOptions.plugins = { tooltip: scatterTooltipCallbacks('Comp. Únicos', 'Total Evt.') };
                    titleForChart = 'Dispersión: Componentes Únicos vs Eventos Totales (por Alumno)';
                    break;
                case 'scatterContentViewParticipation':
                    calculatedData = calculateScatterContentViewParticipationData(filteredDataForCharts);
                    datasets = [{ label: 'Alumnos', data: calculatedData, backgroundColor: CHART_COLORS[6] }];
                    chartConfigType = 'scatter';
                    chartOptions.scales = { x: { title: { display: true, text: 'Nº Eventos Visualización' } }, y: { title: { display: true, text: 'Nº Eventos Participación' } } };
                    chartOptions.plugins = { tooltip: scatterTooltipCallbacks('Evt. Visual.', 'Evt. Particip.') };
                    titleForChart = 'Dispersión: Eventos de Visualización vs Participación (por Alumno)';
                    break;
                case 'bubbleStudentAnalysis':
                    calculatedData = calculateBubbleStudentAnalysisData(filteredDataForCharts);
                    datasets = [{ label: 'Alumnos', data: calculatedData, backgroundColor: CHART_COLORS[0] }];
                    chartConfigType = 'bubble';
                    chartOptions.scales = { x: { title: { display: true, text: 'Número de Días Activos' } }, y: { title: { display: true, text: 'Promedio Eventos por Día Activo' } } };
                    chartOptions.plugins = { tooltip: bubbleTooltipCallbacks('Días Act.', 'Ø Evt/Día', 'Total Evt.') };
                    titleForChart = 'Burbujas: Análisis de Alumnos';
                    break;
                case 'bubbleComponentAnalysis':
                    calculatedData = calculateBubbleComponentAnalysisData(filteredDataForCharts);
                    datasets = [{ label: 'Componentes', data: calculatedData, backgroundColor: CHART_COLORS[1] }];
                    chartConfigType = 'bubble';
                    chartOptions.scales = { x: { title: { display: true, text: 'Nº Usuarios Únicos' } }, y: { title: { display: true, text: 'Nº Total Eventos' } } };
                    chartOptions.plugins = { tooltip: bubbleTooltipCallbacks('Usr. Únicos', 'Total Evt.', 'Ø Evt/Usr') };
                    titleForChart = 'Burbujas: Análisis de Componentes';
                    break;
                case 'bubbleContextAnalysis':
                    calculatedData = calculateBubbleContextAnalysisData(filteredDataForCharts);
                    datasets = [{ label: 'Contextos', data: calculatedData, backgroundColor: CHART_COLORS[2] }];
                    chartConfigType = 'bubble';
                    chartOptions.scales = { x: { title: { display: true, text: 'Nº Alumnos Activos' } }, y: { title: { display: true, text: 'Nº Promedio Eventos por Alumno' } } };
                    chartOptions.plugins = { tooltip: bubbleTooltipCallbacks('Alu. Activos', 'Ø Evt/Alu.', 'Total Evt.') };
                    titleForChart = 'Burbujas: Análisis de Contextos';
                    break;
                case 'topIPsByEvents':
                    const ipEvents = calculateTopIPsByEventsData(
                        filteredDataForCharts, 
                        topNModalDefault,
                        includeZeroActivity,
                        includeZeroActivity ? globallyProcessedDataForBaseLists : []
                    );
                    labels = ipEvents.labels;
                    datasets = [{ label: 'Eventos por IP', data: ipEvents.dataValues, backgroundColor: getChartColors(labels.length) }];
                    chartConfigType = 'bar';
                    chartOptions.indexAxis = 'y';
                    chartOptions.scales = { y: { ticks: { autoSkip: false } } };
                    titleForChart = `Top IPs por Número de Eventos (Total: ${labels.length})`;
                    break;
                case 'usersPerIP':
                    const usersIP = calculateUsersPerIPData(
                        filteredDataForCharts, 
                        topNModalDefault,
                        includeZeroActivity,
                        includeZeroActivity ? globallyProcessedDataForBaseLists : []
                    );
                    labels = usersIP.labels;
                    datasets = [{ label: 'Alumnos Únicos por IP', data: usersIP.dataValues, backgroundColor: getChartColors(labels.length) }];
                    chartConfigType = 'bar';
                    chartOptions.indexAxis = 'y';
                    chartOptions.scales = { y: { ticks: { autoSkip: false } } };
                    titleForChart = `Top IPs por Número de Alumnos Únicos (Total: ${labels.length})`;
                    break;
                case 'ipsPerUser':
                    const ipsUser = calculateIPsPerUserData(
                        filteredDataForCharts, 
                        topNModalDefault,
                        includeZeroActivity,
                        includeZeroActivity ? globallyProcessedDataForBaseLists : []
                    );
                    labels = ipsUser.labels;
                    datasets = [{ label: 'IPs Únicas por Alumno', data: ipsUser.dataValues, backgroundColor: getChartColors(labels.length) }];
                    chartConfigType = 'bar';
                    chartOptions.indexAxis = 'y';
                    chartOptions.scales = { y: { ticks: { autoSkip: false } } };
                    titleForChart = `Top Alumnos por Número de IPs Únicas (Total: ${labels.length})`;
                    break;
                default:
                    console.error("Tipo de gráfico desconocido para modal:", type);
                    return;
            }
            
            chartOptions.plugins = {
                ...(chartOptions.plugins || {}), 
                title: { display: true, text: titleForChart, font: { size: 16 } },
                legend: { display: chartConfigType === 'doughnut' || (datasets.length > 1 && datasets.length <= 10 && chartConfigType !== 'scatter' && chartConfigType !== 'bubble') }
            };
            
            let finalChartData;
            if (chartConfigType === 'scatter' || chartConfigType === 'bubble') {
                finalChartData = { datasets: datasets };
            } else {
                finalChartData = { labels: labels, datasets: datasets };
            }

            let hasDataForChart = false;
            if (chartConfigType === 'scatter' || chartConfigType === 'bubble') {
                hasDataForChart = datasets.some(ds => ds.data && ds.data.length > 0);
            } else {
                let hasLabelsForChart = finalChartData.labels && finalChartData.labels.length > 0;
                let hasDataInDatasetsForChart = finalChartData.datasets && finalChartData.datasets.some(ds => ds.data && ds.data.length > 0);
                let allDataValuesAreZeroInDatasetsForChart = finalChartData.datasets && finalChartData.datasets.every(ds => ds.data && ds.data.every(val => val === 0));
                
                if (isRankingChartType && includeZeroActivity && hasLabelsForChart) {
                    hasDataForChart = true; 
                } else if (hasLabelsForChart && hasDataInDatasetsForChart) {
                    if ((chartConfigType === 'doughnut' || chartConfigType === 'pie') && allDataValuesAreZeroInDatasetsForChart && !(isRankingChartType && includeZeroActivity)) {
                         hasDataForChart = false;
                    } else {
                        hasDataForChart = true;
                    }
                }
            }
            
            if (hasDataForChart) { 
                 modalChartInstance = new Chart(ctx, {
                    type: chartConfigType,
                    data: finalChartData,
                    options: chartOptions
                });
                if(modalChartInstance) { 
                    canvas._chartjs = modalChartInstance;
                }
            } else { 
                 ctx.save();
                ctx.textAlign = 'center';
                ctx.textBaseline = 'middle';
                ctx.font = "16px " + Chart.defaults.font.family;
                ctx.fillStyle = "#6c757d";
                ctx.fillText("No hay datos para este gráfico con los filtros actuales.", canvas.width / 2, canvas.height / 2);
                ctx.restore();
            }
        }

        function renderLogTable(data) {
            logTableBody.innerHTML = ''; 
            tableRowCountEl.textContent = '';

            if (data.length === 0) {
                logTableBody.innerHTML = '<tr><td colspan="6" class="text-center">No hay datos para mostrar.</td></tr>';
                tableRowCountEl.textContent = `Mostrando 0 filas.`;
                return;
            }
            
            const fragment = document.createDocumentFragment();
            data.forEach(row => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${row.TIME || ''}</td>
                    <td>${row.FULL_NAME || ''}</td>
                    <td>${row.EVENT_CONTEXT || ''}</td>
                    <td>${row.COMPONENT || ''}</td>
                    <td>${row.EVENT_NAME || ''}</td>
                    <td>${row.DESCRIPTION || ''}</td>
                `;
                fragment.appendChild(tr);
            });
            logTableBody.appendChild(fragment);
            tableRowCountEl.textContent = `Mostrando ${data.length} fila(s).`;
        }

        function showUserMessage(message, type = 'info') { 
            statusMessage.textContent = message;
            statusMessage.className = `mt-3 pt-2 border-top text-${type}`;
        }

        function handleDownloadLogsCsv() {
            if (!filteredDataForCharts || filteredDataForCharts.length === 0) {
                showUserMessage("No hay logs filtrados para descargar.", "warning");
                return;
            }

            const headers = [
                CSV_COLUMN_MAPPING.TIME,
                CSV_COLUMN_MAPPING.FULL_NAME,
                CSV_COLUMN_MAPPING.EVENT_CONTEXT,
                CSV_COLUMN_MAPPING.COMPONENT,
                CSV_COLUMN_MAPPING.EVENT_NAME,
                CSV_COLUMN_MAPPING.DESCRIPTION
            ];
            
            const dataForCsv = filteredDataForCharts.map(row => [
                row.TIME || '',
                row.FULL_NAME || '',
                row.EVENT_CONTEXT || '',
                row.COMPONENT || '',
                row.EVENT_NAME || '',
                row.DESCRIPTION || ''
            ]);

            const csvContent = convertToCSV(dataForCsv, headers);
            const filename = generateDynamicFilename('moodle_logs_filtrados', 'logs');
            downloadCSV(csvContent, filename);
            showUserMessage(`Logs descargados como ${filename}`, "success");
        }

        function handleDownloadChartCsv(chartInstance, chartType, modalId) {
            if (!chartInstance || !chartInstance.data) {
                showUserMessage("No hay datos en el gráfico para descargar.", "warning");
                return;
            }

            const chartData = chartInstance.data;
            let csvFormattedData = [];
            let csvHeaders = [];
            let baseFilename = chartType || 'chart_data';

            if (chartInstance.options?.plugins?.title?.text) {
                baseFilename = chartInstance.options.plugins.title.text;
            }
            
            switch (chartType) {
                case 'userActivity':
                case 'componentActivity':
                case 'activityByHour':
                case 'activityByDayOfWeek':
                case 'activityByContext':
                case 'topIPsByEvents':
                case 'usersPerIP':
                case 'ipsPerUser':
                    csvHeaders = ['Etiqueta', chartData.datasets[0].label || 'Valor'];
                    if (chartData.labels && chartData.labels.length > 0 && chartData.datasets[0].data.length > 0) {
                        csvFormattedData = chartData.labels.map((label, index) => ({
                            'Etiqueta': label,
                            [csvHeaders[1]]: chartData.datasets[0].data[index]
                        }));
                    }
                    break;
                
                case 'eventsOverTime':
                    csvHeaders = ['Fecha', chartData.datasets[0].label || 'Eventos'];
                     if (chartData.labels && chartData.labels.length > 0 && chartData.datasets[0].data.length > 0) {
                        csvFormattedData = chartData.labels.map((label, index) => {
                            const dateLabel = new Date(label).toLocaleDateString('es-ES', { day: '2-digit', month: '2-digit', year: 'numeric' }) + " " + new Date(label).toLocaleTimeString('es-ES', {hour: '2-digit', minute: '2-digit', second: '2-digit'});
                            return {
                                'Fecha': dateLabel,
                                [csvHeaders[1]]: chartData.datasets[0].data[index]
                            };
                        });
                    }
                    break;

                case 'componentBreakdown':
                    if (chartData.labels && chartData.labels.length > 0) {
                        csvHeaders = ['Componente', ...chartData.datasets.map(ds => ds.label || `Serie ${chartData.datasets.indexOf(ds) + 1}`)];
                        csvFormattedData = chartData.labels.map((label, index) => {
                            const row = { 'Componente': label };
                            chartData.datasets.forEach((ds, dsIndex) => {
                                row[csvHeaders[dsIndex+1]] = ds.data[index];
                            });
                            return row;
                        });
                    }
                    break;

                case 'scatterUsersEventsDay':
                case 'scatterComponentsEventsUser':
                case 'scatterContentViewParticipation':
                    const xAxisLabel = chartInstance.options?.scales?.x?.title?.text || 'X';
                    const yAxisLabel = chartInstance.options?.scales?.y?.title?.text || 'Y';
                    csvHeaders = ['Elemento', xAxisLabel, yAxisLabel];
                    if (chartData.datasets[0] && chartData.datasets[0].data.length > 0) {
                        csvFormattedData = chartData.datasets[0].data.map(point => ({
                            'Elemento': point.label || `Punto (${point.x}, ${point.y})`,
                            [xAxisLabel]: point.x,
                            [yAxisLabel]: point.y
                        }));
                    }
                    break;

                case 'bubbleStudentAnalysis':
                case 'bubbleComponentAnalysis':
                case 'bubbleContextAnalysis':
                    const xBubbleLabel = chartInstance.options?.scales?.x?.title?.text || 'X';
                    const yBubbleLabel = chartInstance.options?.scales?.y?.title?.text || 'Y';
                    let rBubbleLabel = 'Tamaño_Burbuja_Valor_Bruto'; 

                    const tooltipConfig = chartInstance.options?.plugins?.tooltip;
                    if (tooltipConfig && tooltipConfig.callbacks && typeof tooltipConfig.callbacks.label === 'function') {
                        const samplePoint = chartData.datasets[0]?.data[0];
                        if (samplePoint) {
                            // Try to infer R's semantic label from the tooltip configuration
                            if (chartType === 'bubbleStudentAnalysis') rBubbleLabel = 'Total Evt.';
                            else if (chartType === 'bubbleComponentAnalysis') rBubbleLabel = 'Ø Evt/Usr';
                            else if (chartType === 'bubbleContextAnalysis') rBubbleLabel = 'Total Evt.';
                            // This is a heuristic; a more robust way would be to store the desired label in chart options
                        }
                    }
                    
                    csvHeaders = ['Elemento', xBubbleLabel, yBubbleLabel, rBubbleLabel];
                    if (chartData.datasets[0] && chartData.datasets[0].data.length > 0) {
                         csvFormattedData = chartData.datasets[0].data.map(point => ({
                            'Elemento': point.label || `Burbuja (${point.x}, ${point.y})`,
                            [xBubbleLabel]: point.x,
                            [yBubbleLabel]: point.y,
                            [rBubbleLabel]: point._rawR !== undefined ? point._rawR : point.r
                        }));
                    }
                    break;

                default:
                    showUserMessage(`Descarga CSV no implementada para el tipo de gráfico: ${chartType}`, "warning");
                    return;
            }

            if (csvFormattedData.length === 0) {
                let allZeros = false;
                if (chartData.labels && chartData.labels.length > 0 && chartData.datasets[0] && chartData.datasets[0].data) {
                   allZeros = chartData.datasets[0].data.every(val => val === 0);
                }

                if (includeZeroActivity && allZeros && chartType !== 'scatterUsersEventsDay' && chartType !== 'scatterComponentsEventsUser' && chartType !== 'scatterContentViewParticipation' && !chartType.startsWith('bubble')) {
                     if (chartData.labels && chartData.labels.length > 0 && chartData.datasets[0].data.length > 0) {
                        csvFormattedData = chartData.labels.map((label, index) => ({
                            'Etiqueta': label,
                            [csvHeaders[1]]: chartData.datasets[0].data[index] 
                        }));
                    } else {
                        showUserMessage("No hay datos procesados para este gráfico.", "info");
                        return;
                    }
                } else {
                    showUserMessage("No hay datos procesados para este gráfico.", "info");
                    return;
                }
            }
            
            const csvContent = convertToCSV(csvFormattedData, csvHeaders); 
            const filename = generateDynamicFilename(baseFilename, 'grafico');
            downloadCSV(csvContent, filename);
            showUserMessage(`Datos del gráfico descargados como ${filename}`, "success");
        }

    </script>
</body>
</html>
